<?xml version="1.0" encoding="UTF-8"?>
<Window>
	<Sheet>
		<Name>Sheet 1</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>60</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>1018</ChartID>
			<PercentHeight>20</PercentHeight>
			<Formula>// uncomment line below if you want to \r\n// calculate the indicator always using \r\n// SP500 or whatever fixed symbol you wish \r\n// SetForeign("^GSPC" ); \r\n\r\n///This is for SPY - Last updated date : 8/26/2019\r\nhh = High; \r\nll = Low; \r\nBuy=0;\r\nBuyPrice= C;\r\nSellPrice=C;\r\nPosQty = 500; \r\nSetOption( "MaxOpenPositions", PosQty ); \r\nSetPositionSize( 100, spsPercentOfEquity );\r\n//PositionSize =-10;\r\n\r\n//SetTradeDelays( -1, -1, -1, -1 );\r\n\r\nperiodParam =Param("PeriodParam",100, 20, 100, 1);\r\ntargetParam = Param("TargetParam", 0, 0, 20, 1);\r\nperiod = Optimize("Period", periodParam, 20,100,5); //20\r\nperiodH = period;//Optimize("periodH", 20, 20, 100, 5); \r\nperiodL = period;//Optimize("periodL", 20, 20, 100, 5);\r\n\r\nhhh = IIf( hh &gt; Ref( hh, -1 ), \r\n          (hh - LLV( hh, periodH ))/( HHV( hh, periodH) - LLV( hh, periodH) ), \r\n          0 ); \r\n          \r\nhhs = 100 * EMA( hhh, periodH );          \r\n          \r\nlll = IIf( ll &lt; Ref( ll, -1 ), \r\n          (HHV( ll, periodL ) - ll)/( HHV( ll, periodL ) - LLV( ll, periodL ) ), \r\n          0 );          \r\n   \r\nlls = 100 * EMA( lll, periodL );   \r\n\r\nTarget = Optimize("Target Price", targetParam, 2, 20,1); //5\r\n//CutOff = Optimize("Cut Off", 20, 20, 50, 2);\r\nBuySignal = Cross(hhs, lls+Target) OR  ((hhs &gt; lls + target));// AND Close &gt; BuyPrice * (1 + 0.02));//((hhs - lls) &gt; Target) ;\r\nSellSignal = Cross(lls-Target, hhs) OR ((lls-target &gt; hhs));// AND Close &lt; SellPrice * (1 - 0.02));//((lls - hhs) &gt; Target);\r\n\r\n//Short=Sell;\r\n//Cover =Buy;\r\n//BuyEntry =ExRem(BuySignal,SellSignal);\r\n//SellEntry =ExRem(SellSignal, BuySignal);\r\n\r\nBuy = IIf(BuySignal AND (Ref(L,1) &lt;= C AND C &gt;= Ref(H, 1)), sigScaleIn, 0);\r\nSell = IIf(SellSignal AND (Ref(L,1) &lt;= C AND C &gt;= Ref(H, 1)), sigScaleIn, 0);\r\n\r\n//BuyPrice =IIf(Buy, Ref(Close, -1), 0);\r\n//SellPrice = IIf(Sell, Ref(Close, -1), 0);\r\n//Buy = ExRem(Buy, Sell);\r\n//Sell=ExRem(Sell,Buy);\r\n \r\nShort = Sell;\r\nCover = Buy;\r\nPercent = Optimize("Stop Percent", 5, 2,10,1);\r\nApplyStop(stopTypeProfit, stopModePercent, Percent, False);\r\nApplyStop(stopTypeTrailing, stopModePercent, 3, True); \r\n\r\nPlot( hhs, "HHS" + periodH, colorBrightGreen ); \r\nPlot( lls, "LLS" + periodL, colorRed ); \r\n//Plot( BuyPrice, "BuyPrice", colorBrown);\r\nPlot(50, "Cut off ", colorBlue);\r\n</Formula>
			<FilePath>Formulas\\Custom\\Favs\\HHLLS Indicator.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>2.48075</Min>
			<Max>65.6052</Max>
		</Pane>
		<Pane>
			<ChartID>1021</ChartID>
			<PercentHeight>20</PercentHeight>
			<Formula>// uncomment line below if you want to \r\n// calculate the indicator always using \r\n// SP500 or whatever fixed symbol you wish \r\n// SetForeign("^GSPC" ); \r\n\r\n///This is for SPY - Last updated date : 8/26/2019\r\nhh = High; \r\nll = Low; \r\nBuy=0;\r\nSell =0;\r\nBuyPrice= 0;\r\nSellPrice=0;\r\nPosQty = 500; \r\nSetOption( "MaxOpenPositions", PosQty ); \r\nSetPositionSize( 100, spsShares );\r\n//PositionSize =-10;\r\n\r\n//SetTradeDelays( 1, 1, 1, 1 );\r\n\r\nperiodParam =Param("PeriodParam",35, 5, 100, 1);\r\ntargetParam = 0;//Param("TargetParam", 0, 0, 20, 1);\r\nperiod = Optimize("Period", periodParam, 20,100,5); //20\r\nperiodH = period;//Optimize("periodH", 20, 20, 100, 5); \r\nperiodL = period;//Optimize("periodL", 20, 20, 100, 5);\r\n\r\nhhh = IIf( hh &gt; Ref( hh, -1 ), \r\n          (hh - LLV( hh, periodH ))/( HHV( hh, periodH) - LLV( hh, periodH) ), \r\n          0 ); \r\n          \r\nhhs = 100 * EMA( hhh, periodH );          \r\n          \r\nlll = IIf( ll &lt; Ref( ll, -1 ), \r\n          (HHV( ll, periodL ) - ll)/( HHV( ll, periodL ) - LLV( ll, periodL ) ), \r\n          0 );          \r\n   \r\nlls = 100 * EMA( lll, periodL );   \r\n\r\nTarget = Optimize("Target Price", targetParam, 0, 20,1); //5\r\n//CutOff = Optimize("Cut Off", 20, 20, 50, 2);\r\nBuySignal = hhs &gt; lls+Target;\r\n//SellSignal = Cross(lls, hhs);\r\nSellSignal =0;\r\n//Short=Sell;\r\n//Cover =Buy;\r\n//BuySignal =ExRem(BuySignal,SellSignal);\r\n//SellSignal =ExRem(SellSignal, BuySignal);\r\n\r\nBuy = IIf(BuySignal, sigScaleIn, 0);\r\nSell = IIf(SellSignal, sigScaleIn, 0);\r\n\r\n//BuyPrice =IIf(Buy, Ref(Close, -1), 0);\r\n//SellPrice = IIf(Sell, Ref(Close, -1), 0);\r\n//Buy = ExRem(Buy, Sell);\r\n//Sell=ExRem(Sell,Buy);\r\n \r\nShort = Sell;\r\nCover = Buy;\r\nPercent = Optimize("Stop Percent", 4, 2,10,1);\r\nApplyStop(stopTypeProfit, stopModePercent, Percent, False);\r\nApplyStop(stopTypeTrailing, stopModePercent, 3, True); \r\n\r\nPlot( hhs, "HHS" + periodH, colorBrightGreen ); \r\nPlot( lls, "LLS" + periodL, colorRed ); \r\n//PlotShapes(shapeStar, colorBlue);//\r\n//Plot( BuyPrice, "BuyPrice", colorBrown);\r\nPlot(50, "Cut off ", colorBlue);\r\n\r\nif ( Status( "action" ) == actionExplore )\r\n{\r\n//Filter= (BuyPrice!=0 OR SellPrice!=0) AND (hhs-lls&lt;Target OR lls-hhs&lt;Target);\r\n//Explore\r\nFilter =1;\r\n\r\n//text1 = WriteIf(Buy AND (hhs-lls-Target-10 &lt; 0), "Ready to SELL Lower below", "Nothing to do, unless huge price changes");\r\n//text2 = WriteIf(Sell AND (lls-hhs-Target-10 &lt; 0), "Ready to go LONG higher above", text1);\r\n\r\nAddTextColumn(WriteIf(Sell AND (lls-hhs-Target &lt; 0), "Ready to go LONG higher above", WriteIf(Buy AND (hhs-lls-Target &lt; 0), "Ready to SELL Lower below", "Nothing to do, unless huge price changes")), "Signal");\r\nAddColumn(IIf(Buy, L, IIf(Sell, H, 0)),"Price",1.4);\r\nAddColumn( lls-hhs-Target &lt; 0, "lls-hhs-Target &lt; 0", 1);\r\nAddColumn( hhs-lls-Target &lt; 0, "hhs-lls-Target &lt; 0", 1);\r\nAddColumn(hhs, "hhs",1.2);\r\nAddColumn(lls, "lls", 1.2);\r\nAddColumn(hhs-lls-Target, "hhs-lls-Target", 1.2);\r\nAddColumn( Sell, "Sell", 1);\r\nAddColumn( Buy, "Buy", 1);\r\n}\r\n</Formula>
			<FilePath>Formulas\\Custom\\Favs\\HHLLS Indicator -SPY Working.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>-0.212776</Min>
			<Max>88.1339</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 2</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>2</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("MACD");\r\nr1 = Param( "Fast avg", 12, 2, 200, 1 );\r\nr2 = Param( "Slow avg", 26, 2, 200, 1 );\r\nr3 = Param( "Signal avg", 9, 2, 200, 1 );\r\nPlot( ml = MACD(r1, r2), StrFormat(_SECTION_NAME()+"(%g,%g)", r1, r2), ParamColor("MACD color", colorRed ), ParamStyle("MACD style") );\r\nPlot( sl = Signal(r1,r2,r3), "Signal" + _PARAM_VALUES(), ParamColor("Signal color", colorBlue ), ParamStyle("Signal style") );\r\nPlot( ml-sl, "MACD Histogram", ParamColor("Histogram color", colorDefault ), styleNoTitle | ParamStyle("Histogram style", styleHistogram | styleNoLabel, maskHistogram ) );\r\n\r\nif( Status("action") == actionCommentary )\r\n{\r\nBuy=Cross( ml, sl );\r\nSell = Cross( sl, ml );\r\n\r\nprintf("\\nMACD Value: " + WriteVal( ml )+\r\n", Signal Line: " + WriteVal( sl ));\r\n\r\nprintf("\\n\\nThe MACD can provide buy/sell indications in three ways, signal line crossovers, overbought/oversold conditions, and divergences.\\n");\r\n\r\n\r\nprintf("\\n\\nCrossovers:\\n");\r\nprintf("\\nCurrently the MACD is "+\r\nWriteIf(MACD() &gt; Signal(),"bullish","bearish")+\r\n" since it is trading "+\r\nWriteIf(MACD() &gt; Signal(),"above","below")+\r\n" its signal line.");\r\n\r\n\r\nprintf("\\nThe MACD crossed "+\r\nWriteIf(MACD() &gt; Signal(),"above","below")+\r\n" its signal line "+\r\nWriteVal( Min( BarsSince( Cross( MACD(), Signal() )), BarsSince( Cross( Signal(), MACD()))), 0.0)+\r\n" period(s) ago.");\r\n\r\nbars=SelectedValue(Min( BarsSince( Cross( MACD(), Signal() )), BarsSince( Cross( Signal(), MACD())) ));\r\n\r\nprevclose=Ref(Close,-bars);\r\n\r\nprintf("\\nSince the MACD crossed its moving average, "+\r\nName()+"'s price has "+\r\nWriteIf(Close&gt;prevclose,"increased ","decreased ")+\r\nWriteVal(100*(Close-prevclose)/prevclose) + "%");\r\n\r\nprintf("\\nAnd has ranged from a high of "+\r\nWriteVal(HHV(High,bars+1),6.3)+\r\n" to a low of "+\r\nWriteVal(LLV(Low,bars+1),6.3));\r\n\r\nprintf("\\n\\nOverbought/Oversold:");\r\nOsc = OscP( 12, 26 );\r\nOsc1 = Ref( Osc, -1 );\r\nOsc5 = Ref( Osc, -5 );\r\n\r\nprintf("\\n"+WriteIf( Osc &lt;= -3 AND ( Osc - Osc5 ) == -Sum( abs( Osc - Osc1 ), 5 ),\r\n"The MACD is in an oversold range. Prices may continue to move lower for some time.  Wait for prices to move higher before considering any long positions.", \r\nWriteIf( Osc &gt;= 3 AND ( Osc - Osc5 ) ==  Sum( abs( Osc - Osc1 ), 5 ), \r\n"The MACD is in an overbought range.  Prices may continue to move higher for some time.  Wait for prices to move lower before considering any short positions.", \r\n"The MACD is not in an Overbought/Oversold range.")));\r\n\r\nprintf("\\n\\nDivergence:\\n");\r\ntemp = Trough(Low, 2, 1) &lt; 0.96 * Ref( Trough(Low, 2, 1), -1) AND ValueWhen( Trough(Low, 2, 1) != Ref( Trough(Low, 2, 1), -1 ), MACD(), 1 ) &gt;= 0.90 * ValueWhen( Trough( Low, 2, 1) != Ref( Trough( Low, 2, 1), -1 ), MACD(), 2 ) AND MACD() &lt; 0;\r\n\r\ntemp2= Peak(  High,2, 1) &gt; 1.04 * Ref( Peak( High, 2, 1), -1) AND ValueWhen( Peak( High, 2, 1) != Ref( Peak( High, 2, 1), -1 ), MACD(), 1 ) &lt;= 0.90 * ValueWhen( Peak(  High, 2, 1) != Ref( Peak(  High, 2, 1), -1 ), MACD(), 2 ) AND MACD() &gt; 0;\r\n\r\nprintf(WriteIf( HHV( temp, 5 ) == 1,"A bullish divergence occurred " + WriteVal( BarsSince( temp ), 1.0 ) + \r\n" period(s) ago. Wait for upward price movement for confirmation before considering any long positions.",\r\nWriteIf( HHV( temp2,5) == 1,\r\n"A bearish divergence occurred " +\r\nWriteVal( BarsSince( temp2 ), 1.0 ) +\r\n" period(s) ago.  Wait for downward price movement for confirmation before considering any short positions.",\r\n"There have been no divergence signals within the last 5 periods." ) ));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_MACD.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>-2.31353</Min>
			<Max>0.956915</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 3</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>3</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("RSI");\r\nSetChartOptions(0,0,chartGrid30|chartGrid70);\r\nperiods = Param( "Periods", 15, 1, 200, 1 );\r\nPlot( vrsi = RSI( periods), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style")  );\r\n\r\nif( Status("action") == actionCommentary ) \r\n{\r\n\r\nBuy = Cross( vrsi, 30 );\r\nSell = Cross( 70, vrsi );\r\n\r\nprintf( "The current value for the RSI" + periods + " is " + WriteVal( vrsi ) );\r\n\r\nprintf("\\n\\nThe RSI, written by J. Welles Wilder in 1978, can be used in several different ways to analyze a chart.\\n");\r\n\r\nprintf("Tops and Bottoms:\\n\\n");\r\n\r\nprintf( \r\nWriteIf( vrsi &gt; 70, "The RSI is above 70.  This is where it usually tops.  The RSI usually forms tops and bottoms before the underlying security.",\r\nWriteIf( vrsi &lt; 30, "The RSI is below 30.  This is where it usually bottoms.  The RSI usually forms tops and bottoms before the underlying security.",\r\n"The RSI is not currently in a topping (above 70) or bottoming (below 30) range. " \r\n+ WriteIf( Cross( 70, vrsi ), "However, the RSI just crossed below 70 from a topping formation.  This is a bearish sign.",\r\nWriteIf( Cross( vrsi, 30 ), "However, the RSI just crossed above 30 from a bottoming formation.  This is a bullish sign.", "" ) ) ) ) ); \r\n\r\nbars30 = BarsSince( Buy );\r\nbars70 = BarsSince( Sell );\r\n\r\nprintf("\\n\\nBuy/Sell signals:");\r\nprintf("\\nA buy or sell signal is generated when the RSI moves out of an overbought/oversold area. \\nThe last signal was a "+\r\nWriteIf( bars30 &lt; bars70, "buy", WriteIf( bars30 &gt; bars70, "sell", "" ))+\r\nWriteVal( Min( bars30, bars70 ), 3.0 ) + " period(s) ago.");\r\n\r\nprintf("\\n\\nChart Formations:");\r\n\r\nprintf("\\nThe RSI often forms chart patterns (such as head and shoulders or rising wedges) and support/resistance levels that may or may not be visible on the price chart.  "+\r\n"Since the analysis of chart patterns/formations is subjective, the automatic interpretator cannot find them.  Please visually inspect the chart and look for such patterns.");\r\n\r\nprintf("\\n\\nFailure Swings (also known as support or resistance penetrations or breakouts):");\r\nprintf(\r\nWriteIf( vrsi &gt;= HHV( vrsi, 14 ), "The RSI has just reached its highest value in the last 14 period(s).  This is bullish.",\r\nWriteIf( vrsi &lt;= LLV( vrsi, 14 ), "The RSI has just reached its lowest value in the last 14 period(s).  This is bearish.",\r\n"The RSI does not currently show any Failure Swings." ) ) );\r\n\r\nprintf("\\n\\nDivergence:\\n");\r\nprintf(\r\nWriteIf( Close &gt;= HHV( Close, 14 ) AND vrsi &lt; HHV( vrsi, 14 ), \r\n"The security price has set a new 14-day high while the RSI has not.  This is a bearish divergence.",\r\nWriteIf( vrsi &gt;= HHV( vrsi, 14 ) AND Close &lt; HHV( Close, 14 ), \r\n"The RSI has set a new 14-day high while the security price has not.  This is a bullish divergence.",\r\nWriteIf( Close &lt;= LLV( Close, 14 ) AND vrsi &gt; LLV( vrsi, 14 ), \r\n"The security price has set a new 14-day low while the RSI has not.  This is a bullish divergence.",\r\nWriteIf( vrsi &lt;= LLV( vrsi, 14) AND Close &gt; LLV(Close,14), \r\n"The RSI has set a new 14-day low while the security price has not.  This is a bearish divergence.",\r\n"The RSI and price are not diverging." ) ) ) )); \r\n\r\nprintf("\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_RSI.afl</FilePath>
			<Flags>3072</Flags>
			<MoreFlags>1073741825</MoreFlags>
			<Min>21.4536</Min>
			<Max>78.4176</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 4</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>4</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("ROC");\r\nP = ParamField( "Price field" );\r\nperiods = Param("Periods", 15, 1, 200, 1 );\r\nPlot( ROC( P, periods), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style")  );\r\n\r\nif( Status("action") == actionCommentary )\r\n{\r\n printf("(Interpretation is not available yet)");\r\n}\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_ROC.afl</FilePath>
			<Flags>258</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>-10.8649</Min>
			<Max>6.32941</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 5</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>5</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("Stochastic Slow");\r\nperiods = Param( "Periods", 15, 1, 200, 1 );\r\nKsmooth = Param( "%K avg", 3, 1, 200, 1 );\r\nPlot( StochK( periods , Ksmooth), "%K"+_PARAM_VALUES(), ParamColor( "%K color", colorCycle ), ParamStyle("%K style") );\r\nDsmooth = Param( "%D avg", 3, 1, 200, 1 );\r\nPlot( StochD( periods , Ksmooth, DSmooth ), "%D"+_PARAM_VALUES(), ParamColor( "%D color", colorCycle ), ParamStyle("%D style") );\r\n\r\nif( Status("action") == actionCommentary )\r\n{\r\n printf("(Interpretation is not available yet)");\r\n}\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Stochastic_Slow.afl</FilePath>
			<Flags>3072</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>2.9764</Min>
			<Max>103.085</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 6</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>6</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("Volume");\r\nPlot( Volume, _DEFAULT_NAME(), IIf( C &gt; O, ParamColor("Up Color", colorGreen ), ParamColor("Down Color", colorRed ) ), ParamStyle( "Style", styleHistogram | styleThick, maskHistogram  ) );\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Volume.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>-0.002</Min>
			<Max>0.10512</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 7</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>75</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>7</ChartID>
			<PercentHeight>25</PercentHeight>
			<Formula>_SECTION_BEGIN("Ultimate");\r\nr1 = Param("Fast avg", 7, 2, 200, 1 );\r\nr2 = Param("Med avg", 14, 2, 200, 1 );\r\nr3 = Param("Slow avg", 28, 2, 200, 1 );\r\nPlot( Ultimate( r1, r2, r3 ), _DEFAULT_NAME(), ParamColor("Color", colorCycle ), ParamStyle("Style"));\r\n\r\nif( Status("action") == actionCommentary )\r\n{\r\n  printf( "(Interpretation is not available yet)" );\r\n}\r\n\r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Ultimate.afl</FilePath>
			<Flags>19456</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>27.9657</Min>
			<Max>76.7257</Max>
		</Pane>
	</Sheet>
	<Sheet>
		<Name>Sheet 8</Name>
		<Pane>
			<ChartID>1</ChartID>
			<PercentHeight>55</PercentHeight>
			<Formula>_SECTION_BEGIN("Price");\r\nSetChartOptions(0,chartShowArrows|chartShowDates);\r\n_N(Title = StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} Open %g, Hi %g, Lo %g, Close %g (%.1f%%) Vol " +WriteVal( V, 1.0 ) +" {{VALUES}}", O, H, L, C, SelectedValue( ROC( C, 1 )) ));\r\nPlot( C, "Close", ParamColor("Color", colorDefault ), styleNoTitle | ParamStyle("Style") | GetPriceStyle() ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 200, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Mid MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 45, 2, 300, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Long MA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 100, 2, 400, 1 );\r\nPlot( MA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style", styleHidden | styleLine | styleNoLabel ) | styleNoRescale ); \r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("BBands");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 100, 1 );\r\nWidth = Param("Width", 2, 0, 10, 0.05 );\r\nColor = ParamColor("Color", colorLightGrey );\r\nColor = ColorBlend( Color,  GetChartBkColor(), 0.5 );\r\nStyle = ParamStyle("Style", styleLine | styleNoLabel ) | styleNoRescale;;\r\nPlot( bbt = BBandTop( P, Periods, Width ), "BBTop" + _PARAM_VALUES(), Color, Style ); \r\nPlot( bbb = BBandBot( P, Periods, Width ), "BBBot" + _PARAM_VALUES(), Color, Style ); \r\nPlotOHLC( bbt, bbt, bbb, bbb, "", ColorBlend( Color, GetChartBkColor(), 0.7 ), styleNoLabel | styleCloud | styleNoRescale, Null, Null, Null, -1 );\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("Price Interpretation");\r\nmovshort = ParamField("Short Time MA", 8 );\r\nmovmed = ParamField("Mid Time MA", 9 );\r\nmovlong = ParamField("Long Time MA", 10 );\r\nbtop = ParamField("BBTop", 11 );\r\nbbot = ParamField("BBBottom", 12 );\r\nif( Status("action") == actionCommentary )\r\n{\r\nwidth = btop - bbot;\r\nlslop = LinRegSlope( C, 30 ) + 100;\r\nlslo = LLV( lslop, 90 );\r\nlshi = HHV( lslop, 90 );\r\nlswidth = lshi - lslo;\r\ntrend = 100*( lslop - lslo )/lswidth;\r\n\r\nmawidth = MA( width, 100 );\r\nrelwidth = 100*(width - mawidth)/mawidth;\r\n\r\n_N( tname = Name()+"("+FullName()+")" );\r\n\r\nprintf("Price and moving averages:\\n");\r\nprintf( tname + " has closed " + WriteIf( C &gt; movshort, "above" , "below" ) + " its Short time moving average. ");\r\n\r\nprintf("\\nShort time moving average is currently " + WriteIf( movshort &gt; movmed, "above", "below") + " mid-time, AND " + WriteIf( movshort &gt; movlong, "above", "below" ) + " long time moving averages.");\r\n\r\nprintf("\\nThe relationship between price and moving averages is: "+\r\nWriteIf( C &gt; movshort AND movshort &gt; movmed, "bullish",\r\nWriteIf( C &lt; movshort AND movshort &lt; movmed, "bearish", "neutral" ) ) + " in short-term, and "+\r\nWriteIf( movshort &gt; movmed AND movmed &gt; movlong , "bullish",\r\nWriteIf( movshort &lt; movmed AND movmed &lt; movlong, "bearish", "neutral" ) ) + " in mid-long term. ");\r\n\r\nprintf("\\n\\nBollinger Bands:\\n");\r\nprintf(tname+ " has closed " + \r\nWriteIf( C &lt; bbot, "below the lower band by " +\r\nWriteVal( 100 *( bbot-C )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &lt; 30, " This combined with the steep downtrend can suggest that the downward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the lower band and a downside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &gt; btop, "above the upper band by " +\r\nWriteVal( 100 *( C- btop )/ width, 1.1 ) + "%%. " +\r\nWriteIf( trend &gt; 70, " This combined with the steep uptrend suggests that the upward trend in prices has a good chance of continuing.  However, a short-term pull-back inside the bands is likely.",\r\nWriteIf( trend &gt; 30 AND trend &lt; 70, "Although prices have broken the upper band and a upside breakout is possible, the most likely scenario for "+tname+" is to continue within current trading range.", "" ) ), "" ) +\r\n\r\nWriteIf( C &lt; btop AND ( ( btop - C ) / width ) &lt; 0.5, \r\n"below upper band by " +\r\nWriteVal( 100 *( btop - C )/ width, 1.1 ) + "%%. ", \r\nWriteIf( C &lt; btop AND C &gt; bbot , "above bottom band by " +\r\nWriteVal( 100 *( C - bbot )/ width, 1.1 ) + "%%. ", "" ) ));\r\n\r\nprintf("\\n"+\r\nWriteIf( ( trend &gt; 30 AND trend &lt; 70 AND ( C &gt; btop OR C &lt; bbot ) ) AND abs(relwidth) &gt; 40,\r\n\t\t "This picture becomes somewhat unclear due to the fact that Bollinger Bands are  currently",\r\n\t\t "Bollinger Bands are " )+\t  \r\nWriteVal( abs( relwidth ), 1.1 ) + "%% " +\r\nWriteIf( relwidth &gt; 0, "wider" , "narrower" ) +\r\n" than normal.");\r\n\r\nprintf("\\n");\r\n\r\nprintf(\r\nWriteIf( abs( relwidth ) &lt; 40, "The current width of the bands (alone) does not suggest anything conclusive about the future volatility or movement of prices.","")+\r\nWriteIf( relwidth &lt; -40, "The narrow width of the bands suggests low volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility increasing with a sharp price move has increased for the near-term. "+\r\n"The bands have been in this narrow range for " + WriteVal(BarsSince(Cross(-40,relwidth)),1.0) + " bars. The probability of a significant price move increases the longer the bands remain in this narrow range." ,"")+\r\nWriteIf( relwidth &gt; 40, "The large width of the bands suggest high volatility as compared to " + tname + "'s normal range.  Therefore, the probability of volatility decreasing and prices entering (or remaining in) a trading range has increased for the near-term. "+\r\n"The bands have been in this wide range for  " + WriteVal(BarsSince(Cross(relwidth,40)),1.0) + " bars.The probability of prices consolidating into a less volatile trading range increases the longer the bands remain in this wide range." ,""));\r\n\r\nprintf("\\n\\nThis commentary is not a recommendation to buy or sell. Use at your own risk.");\r\n}\r\n_SECTION_END();\r\n\r\n_SECTION_BEGIN("EMA");\r\nP = ParamField("Price field",-1);\r\nPeriods = Param("Periods", 15, 2, 300, 1, 10 );\r\nPlot( EMA( P, Periods ), _DEFAULT_NAME(), ParamColor( "Color", colorCycle ), ParamStyle("Style") ); \r\n_SECTION_END();\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_Price.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1073741835</MoreFlags>
			<Min>63.3966</Min>
			<Max>104.925</Max>
		</Pane>
		<Pane>
			<ChartID>8</ChartID>
			<PercentHeight>45</PercentHeight>
			<Formula>_SECTION_BEGIN("OBV");\r\n\r\nPlot( OBV(), _DEFAULT_NAME(), ParamColor("Color", colorCycle ), ParamStyle("Style")  );\r\n\r\nif( Status("action") == actionCommentary )\r\n{\r\nprintf("Interpretation is NOT available yet)");\r\nprintf("On Balance Volume is a running total of volume. It shows if volume is flowing into or out of a security.");\r\n}\r\n\r\n_SECTION_END();\r\n\r\n //Automatic support resistance determination. v 3.2\r\n//Abnash Singh December 19, 2013\r\n//Copyright and all rights reserved.\r\n//revision Dec 28 - added custom plots\r\n//Revision March 7 2014 - filler lines option added\r\n//Revision March 8, 2014 - Camarilla and ORB lines incorporated. \r\n//Revision May 22, 2014 - Gann logic improvements\r\n//Revision 3.1 May 22, 2014 - Gann logic improvements\r\n//Revision 3.2 May 25, 2014 - Inside bar logic introduced to reduce noise\r\n//Revision 3.3 May 28, 2014 - Error related to null rounded lows and highs for bar 0 fixed\r\n//Revision 3.4 August 3, 2014 - Auto plots of Fibs using manually given gap or defined lookback period\r\n//Revision 3.5 Nov 21, 2014 - Introduced auto signals \r\n//Revisoon 3.6 Nov 25, 2014 - Auto Fib levels and Kagi lines introduced\r\n//January 4th 2015 - Added kagi charts titles.\r\n//Revison 4.3 Profit module shows and prints profits correctly.\r\n//Revision 5 Auto trades added for SR and retracement methods \r\n//Revision 5.1 Writes displayed trades to file for re-use\r\n//Revision 5.3 Added stoploss ratio and trailing SL\r\n//Revision 5.4.2 Skips short trades optionally.\r\n//Revision 5.4.1 MA-SR bug which was counting trade gap from MA cross incorrectly for longs fixed.\r\n//Revision 5.4.2 added 2 new profit exit modes - Target 2 and Threshold\r\n//Revision 5.4.3 Changes in MA cross logic and introducing pure MA cross trade type coupled with GannTrend\r\n\r\n\r\n//Current trade types :\r\n//All trades use Gann Trend confirmation for entry of Buys and Shorts.\r\n//Retracement : Swing based entries based on retracement logic\r\n//SR Swing : Swing based entries based on support and resistance breaks\r\n//SR Break : New trades on break of every support and resistance\r\n//MA versions of Retracement and SR Swing : Requires moving averages to cross over to confirm a buy or short entry\r\n//MA Cross : Trades based on Moving Average Crossover.\r\n\r\nSetBarsRequired(10000,10000);\r\n\r\nfunction timecon(intime)//converts time given as 930 to 09:30 and so on.\r\n{\r\n\txhr=int(intime/100);\r\n\txmin=intime%100;\r\n\txhrx=WriteIf(xhr&lt;10,"0"+NumToStr(xhr,1,0),NumToStr(xhr,1,0));\r\n\txminx=WriteIf(xmin&lt;10,"0"+NumToStr(xmin,1,0),NumToStr(xmin,1,0));\r\n\txhrx=xhrx+":"+xminx;\r\n\treturn xhrx;\r\n}\r\nfunction roundy(x,y,i,fac,decimals) \r\n{\r\n\r\n\r\nresult=0;div=1;\r\nfac1=fac;\r\nx1=x;y1=y;\r\n\r\nif (int(fac)!=fac){fac1=fac*10^decimals;x1=x1*10^decimals;y1=y1*10^decimals;div=10^decimals;}  \r\n\r\n\r\nOuth=int(x1/fac1)*fac1;\r\nOutl=int(y1/fac1)*fac1;\r\n\r\n\r\nOutl=IIf(Outl*IIf(fac&lt;1 AND y*div!=Outl,fac,1)/div&lt;y,int((Outl+fac1)/fac1)*fac1,Outl);\r\n\r\n\r\nif (int(fac)!=fac){Outh=Outh/div;Outl=Outl/div;}\r\n\r\n\r\n//if (!IsNull(outh) AND (Outh&gt;x OR Outh&lt;y))Outh=Null;\r\n//if (!IsNull(outl) AND (Outl&gt;x OR Outl&lt;y))Outl=Null;\r\n//if (!IsNull(Outh) AND IsNull(Outl))Outl=Outh;\r\n//if (!IsNull(Outl) AND IsNull(Outh))Outh=Outl;\r\n\r\n//Outh=IIf(Outh&lt;y,Null,IIf(Outh&gt;x,Null,Outh));\r\n//Outl=IIf(outl&gt;x,outh,IIf(Outl&gt;Outh,Outh,Outl));\r\nif (!IsNull(Outh) AND !IsNull(Outl))result=1;\r\nelse result=0;\r\n\r\n\r\n\r\nreturn result;\r\n}\r\nfunction roundx(x,y,i,fac,decimals) \r\n{\r\nglobal ah,al;\r\n\r\nresult=0;div=1;\r\nfac1=fac;\r\nx1=x;y1=y;\r\n\r\nif (int(fac)!=fac){fac1=fac*10^decimals;x1=x1*10^decimals;y1=y1*10^decimals;div=10^decimals;}  \r\n\r\n\r\nOuth=int(x1/fac1)*fac1;\r\nOutl=int(y1/fac1)*fac1;\r\n\r\n\r\nOutl=IIf(Outl*IIf(fac&lt;1 AND y*div!=Outl,fac,1)/div&lt;y,int((Outl+fac1)/fac1)*fac1,Outl);\r\n\r\n\r\nif (int(fac)!=fac){Outh=Outh/div;Outl=Outl/div;}\r\n\r\n\r\nif (!IsNull(outh) AND (Outh&gt;x OR Outh&lt;y))Outh=Null;\r\nif (!IsNull(outl) AND (Outl&gt;x OR Outl&lt;y))Outl=Null;\r\nif (!IsNull(Outh) AND IsNull(Outl))Outl=Outh;\r\nif (!IsNull(Outl) AND IsNull(Outh))Outh=Outl;\r\n\r\n//Outh=IIf(Outh&lt;y,Null,IIf(Outh&gt;x,Null,Outh));\r\n//Outl=IIf(outl&gt;x,outh,IIf(Outl&gt;Outh,Outh,Outl));\r\nif (!IsNull(Outh) AND !IsNull(Outl))result=1;\r\nelse result=0;\r\n\r\nah[i]=Outh;\r\nal[i]=Outl;\r\n\r\nreturn result;\r\n}\r\n\r\nNamebn="BANKNIFTY-I";\r\nNamenf="NIFTY-I"; \r\nstartx=Param("How many days of data to use?",20,1,3000,1);\r\nplotsrchart=ParamToggle("Show SR Chart","No|Yes",0);\r\nplotkagichart=ParamToggle("Show Kagi Chart","No|Yes",1);\r\nshowganntitle=ParamToggle("Swing Profits?","No|Yes",0);\r\nplotSR=ParamToggle("Show SR Averages ","Off|On",1);\r\nplotsrbars=ParamToggle("Show SR Bars ","Off|On",1);\r\nkagibarc=Param("How Many Kagi bars?",10,1,1000,1);\r\nkagioffset=Param("Offset from end",0,0,200,10);\r\n\r\nohlccolor=ParamToggle("Candle/Bar color","Grey|Normal");\r\nplotSAR=ParamToggle("Show SAR Averages","Off|On",0);\r\nshowvol=ParamToggle("Show Volatility Band","Off|On",0);\r\n\r\navperiod1=Param("Average period fast 1", 6,0,40,1);\r\navperiod2=Param("Average period fast 2", 12,0,60,1);\r\navperiod3=Param("Average period slow", 35,0,150,1);\r\nVar=ParamToggle("Variable/Fixed","Fixed|Variable",0); \r\nrfac1=Param("S/R gap",1,0,50,1);\r\nfillerbar=ParamToggle("Show Filler lines","No|Yes",1);\r\n\r\nswname=Paramlist("Switch to NIFTY (yes)/No (BANKNIFTY","BANKNIFTY|NIFTY|Default",1);\r\nmLine1=Param("Line 1 level",0,0,20000,0.01);\r\nmLine2=Param("Line 2 level",0,0,20000,0.01);\r\nmLine3=Param("Line 3 level",0,0,20000,0.01);\r\nmLine4=Param("Line 4 level",0,0,20000,0.01);\r\nmLine5=Param("Line 5 level",0,0,20000,0.01);\r\n\r\nrangeperiod=Param("Period for range lookback",50,10,200,1);\r\nshowatr=ParamToggle("Show traded range ?","No|Yes",0);\r\nshoworb=ParamList("Show ORB ? Single/Double","None|Single|Double",0);\r\nshowcam=Paramlist("Show Camarilla","Cam|Orb|None",2);\r\ncamperiod=ParamList("Camarilla period","Daily|Weekly|Fortnightly|Monthly",0);\r\nshowwhat=IIf(ParamList("Camarilla - Current or next period Levels","Current|Next")=="Next",1,-1);\r\nshowmid=ParamToggle("Show Camarilla midline","Off|On",0);\r\nwriteall=ParamTrigger("Write all rounded records","Write");\r\nprintall=ParamTrigger("Print trades","Print All");\r\nwritetrades=ParamTrigger("Write trades to file","Output All Trades");\r\nreadtrades=ParamTrigger("Read trades from file","Read All Trades");\r\n\r\nshowsr=ParamToggle("Show PK/TR support/resistances","No|Yes",0);\r\nshowpktrfib=ParamToggle("Show PK/TR fibs","No|Yes",0);\r\nsrarrayindex=Param("SR Array Index",8,0,40,1);\r\nsrmid=ParamToggle("Show mid SR?","No|Yes",0);\r\n\r\n\r\n\r\n\r\n\r\nfibmid=fibhigh=fiblow=fib764=fib618=fib382=fib236=Null;\r\n\r\n\r\n\r\nmLine1=IIf(mLine1==0,Null,mLine1);\r\nmLine2=IIf(mLine2==0,Null,mLine2);\r\nmLine3=IIf(mLine3==0,Null,mLine3);\r\nmLine4=IIf(mLine4==0,Null,mLine4); \r\nmLine5=IIf(mLine5==0,Null,mLine5);\r\nsname=Name();\r\nif (StrLeft(Name(),5)=="NIFTY" AND swname=="NIFTY"){SetForeign(Namenf);sname=Namenf;}\r\nelse if (StrLeft(Name(),9)=="BANKNIFTY" AND swname=="BANKNIFTY"){SetForeign(Namebn);sname=Namebn;}\r\n\r\nrfac=0;\r\nif (Interval()&lt;=300)\r\n{\r\n\tif (StrLeft(Name(),5)=="NIFTY")rfac=4;\r\n\telse if (StrLeft(Name(),9)=="BANKNIFTY")rfac=8;\r\n\telse if (StrLeft(Name(),7)=="YESBANK")rfac=1;\r\n\telse if (StrLeft(Name(),2)=="ES")rfac=4;\r\n\telse rfac=1;\r\n}\r\nelse if (Interval()&gt;=3600)\r\n{\r\n\tif (StrLeft(Name(),5)=="NIFTY")rfac=16;\r\n\telse if (StrLeft(Name(),9)=="BANKNIFTY")rfac=40;\r\n\telse if (StrLeft(Name(),7)=="YESBANK")rfac=4;\r\n\telse if (StrLeft(Name(),2)=="ES")rfac=2;\r\n\telse rfac=1;\r\n}\r\nelse if (Interval()&gt;300)\r\n{\r\n\tif (StrLeft(Name(),5)=="NIFTY")rfac=8;\r\n\telse if (StrLeft(Name(),9)=="BANKNIFTY")rfac=20;\r\n\telse if (StrLeft(Name(),7)=="YESBANK")rfac=2;\r\n\telse if (StrLeft(Name(),2)=="ES")rfac=1;\r\n\telse rfac=1;\r\n}\r\n\r\nbarind=BarIndex();\r\nsbb=SelectedValue(BarIndex());\r\ndtx=Day();\r\nmth=Month()*100;\r\nYr=Year();\r\nHr=Hour();\r\nMn=Minute();\r\nChid=GetChartID();\r\nsdtx=SelectedValue(dtx);\r\nsmth=SelectedValue(mth);\r\nsYr=SelectedValue(yr);\r\nsHr=SelectedValue(Hr);\r\nsMn=SelectedValue(Mn);\r\n\r\nif (Var)rfac=rfac1;\r\n\r\n\r\nbarind=BarIndex();\r\nsbb=SelectedValue(BarIndex());\r\n//Output=int(input);\r\n\r\n\r\nah=al=to=th=tl=tc=Null;\r\ndtx=Day();\r\nmth=Month();\r\nYr=Year();\r\nHr=Hour();\r\nMn=Minute();\r\nhrmn=hr*100+mn;\r\nselyr=SelectedValue(yr);\r\nselmth=SelectedValue(mth);\r\nseldtx=SelectedValue(dtx);\r\nselhr=SelectedValue(hr);\r\nselmn=SelectedValue(mn);\r\nddx=DaysSince1900();\r\nddxbc=ddx[BarCount-1];\r\n\r\n\r\n\r\nVal=freq=0;\r\njcount=jlim=0;\r\nLastah=Lastal=0;\r\n//ORB Variables\r\ntimesetting=093000;\r\ntn=TimeNum();\r\nDatey=DateNum();\r\nfastprice=lev=0;\r\navp=(O+C)/2;\r\n\r\n\r\ndaysttime=091500;\r\nbardb=IIf(tn==daysttime,1,0);\r\nr2=s2=ar1=ar2=ar3=bs1=bs2=bs3=0;\r\nfastbuy=fastsell=0;\r\nLastsig=Buycond=Shortcond=dayopen=dayclose=prevdayhigh=prevdaylow=dayhigh=daylow=xh=xl=xc=xxh=xxl=xcmid=cline=v1=v2=0;\r\n//Orb end\r\n//Cam on\r\nif (showcam=="Cam")\r\n{\r\n\tcperiod=inDaily;\r\n\tif (camperiod=="Daily")cperiod=inDaily;\r\n\telse if (camperiod=="Weekly")cperiod=inweekly;\r\n\telse if (camperiod=="Fortnightly")cperiod=inWeekly*2;\r\n\telse if (camperiod=="Monthly")cperiod=inmonthly;\r\n\tXH = TimeFrameGetPrice( "H", cperiod,showwhat);\r\n\tXL = TimeFrameGetPrice( "L", cperiod,showwhat);\r\n\tXC = TimeFrameGetPrice( "C", cperiod, showwhat );\r\n}\r\n//\r\n\r\n\r\n\r\n\r\navin[BarCount-1]=Lastah;\r\nto[BarCount-1]=O[BarCount-1];\r\nth[BarCount-1]=H[BarCount-1];\r\ntl[BarCount-1]=L[BarCount-1];\r\ntc[BarCount-1]=C[BarCount-1];\r\n\r\nif (showcam=="Cam")\r\n{\r\n\tmline1=r2=(((xh-xl)*1.1)/2)+xc;\r\n\tmline2=r1=(((xh-xl)*1.1)/4)+xc;\r\n\tmline3=s1=(xc-((xh-xl)*1.1)/4);\r\n\tmline4=s2=(xc-((xh-xl)*1.1)/2);\r\n\tif (showmid)mline5=(mline2+mline3)/2;\r\n}\r\n\r\n\r\n\r\n\r\ntr=ATR(rangeperiod);\r\nHt=tr[BarCount-10]/3;\r\nif (showatr)PlotText("Avg Range\\n"+WriteVal(tr[BarCount-1],1.),BarCount-10,H[BarCount-1]+Ht,colorGreen);\r\n\r\n\r\n_SECTION_BEGIN("Custom_Signals");\r\n\r\nshowauto= ParamToggle ("Show Auto Signals","No|Yes",0);\r\nuseautorange=ParamToggle ("Use Auto range","No|Yes",0);\r\nautodatestart=Param("Date start YYMMDD format",150101,010101,991231,1);\r\nautodateend=Param("Date end YYMMDD format",150101,010101,991231,1); \r\nexitintraday=ParamToggle ("Exit Intraday?","No|Yes",0);\r\nskipshort=ParamToggle("Skip short signals","No|Yes",0);\r\nonskipexitatsl=ParamToggle("If Skip short exit only at SL","No|Yes",0);\r\nsetbuy = ParamTrigger("Buy", "Buy" );\r\nsetsell = ParamTrigger("Sell", "Sell" );\r\nsetshort = ParamTrigger("Short", "Short" ); \r\nsetcover = ParamTrigger("Cover", "Cover" );\r\nshowprice=ParamToggle("Show Trade Value?","No|Yes",1);\r\ntargetmode=ParamToggle("Target Ratio/abs","Abs|Ratio",1);\r\ntarget = Param("Target",0,0,450,1);\r\ntargetratio=Param("Target Ratio",1,1,10,.1);\r\ntarget2ratio=Param("Target2 Ratio",4,1,10,.1);\r\nthreshtog=1;//ParamToggle("Threshold on?","Off|On",0);\r\nthreshpoints=Param("Threshold Exit Points",25,1,100,1);\r\nusethreshratio=ParamToggle("Use Threshold Ratio?","Off|On",0);\r\nthreshratio=Param("Threshold TSL Ratio",1,1,2.5,.1);\r\nshowthreshold=ParamToggle("Show Threshold Level?","Off|On",0);\r\n\r\nslmult=Param("Stop loss multiplier",1,1,10,.1);\r\ntslfac=Param("Trailing Stop Loss",0,0,2,.1);\r\ntrademode = Paramlist("Trade Mode","Retrace|SR-Swing|SR-Break|MA-Retrace|MA-SR|MA-Cross",0);\r\ncrosslim = Param("Crossover bars for MA Filter",11,0,50,1);\r\nmaadj=ParamToggle("Delay MA Cross?","No|Yes",0);\r\nmadist=Param("Distance between MA's at Cross",0,0,100,1);\r\nhhl=ParamToggle("Long High/Short Low ","No|Yes",1);\r\nsethigh=ParamTrigger("Set High for MM", "Set High" );\r\nsetlow=ParamTrigger("Set Low for MM", "Set Low" );\r\nsuppresson = ParamTrigger("Suppress Auto Sig", "From this bar" );\r\nsuppressoff = ParamTrigger("Clear Last Suppress", "From hereon" );\r\nclear = ParamTrigger("Clear Buy Sell", "Clear this signal" );\r\nclearall = ParamTrigger("Clear All Buy Sell", "Clear all trade signals" );\r\nsrn=150;\r\nfor (i=1;i&lt;=srn;i++)\r\n{\r\n\tVarSet("sr"+i,Null);\r\n}\r\n//sr1=sr2=sr3=sr4=sr5=sr6=sr7=sr8=sr9=sr10=sr11=sr12=Null;\r\nBuy=Sell=Short=Cover=lastsig=lastsigi=prevsig=prevsigi=profit=suppon=supoff=exitsigi=\r\n\ttradetypex=exitprice=tradeprice=Maxprofit=Minprofit=targetprofit=slpoints=systemtarget=systemtarget2=systemtargetlevel=nlong=nshort=\r\n\tMaxprofitprev=Minprofitprev=targetprofitprev=target2profitprev=threshprofitprev=exitprofit=exitprofitprev=cumexitprofit=cumtargetprofit=sigi=exiti=tr=\r\n\tdispcumtargetprofit=dispcumexitprofit=dispcumtarget2profit=dispcumthreshprofit=tradect=cumtarget2profit=target2profit=threshprofit=cumthreshprofit=threshval=\r\n\tcumlosse=cumgaine=cumlossr=cumgainr=cumlgaint=cumlosst=cumgaint=cumgaint2=cumlosst2=cprofitflag=nextlong=nextshort=lasttrigger=ztrig=clevel=clevelsig=s1dc=s1uc=r1dc=r1uc=\r\n\tzeodtc=zeodc=cumeode=cumeodr=cumeodt=cumeodt2=cume=cumt=cumt2=cumr=brok=maxprofit=maxprice=minprice=lastcheck=dircount=totalprofit=totalprofitcum=\r\n\tprcount=prnegct=lastsig=sigarray=cumprofit=txnprofit=lastsig1=lastsig1i=prevtxnprofit=cumtargetprofit=txntargetprofit=txntarget2profit=prevtxntargetprofit=targetcum=target2cum=\r\n\ttodaystargetprofit=todaystarget2profit=targetprofit2=threshold=threshcross=threshcrossi=threshflagi=threshstatus=target2=\r\n\tsuccesse=successr=successt=successt2=0;\r\nBuyPrice=ShortPrice=0;\r\nplotthreshold=plottarget1=sl=Null;\r\nChid=GetChartID();\r\njstore=0;\r\n\r\n\r\n\r\n\r\n\r\n\r\nBarLum1 \t\t= Param("Bar Color Intensity", 8, 0, 10,01); \r\n//UpBarColor\t\t= ColorBlend(ColorRGB(5,36,5), ColorRGB(10,75,10), BarLum1);\r\n//DnBarColor\t\t= ColorBlend(ColorRGB(36,5,5), ColorRGB(75,10,10), BarLum1);\r\nganncolor = ColorBlend(ColorRGB(5,36,5), ColorRGB(90,95,50), BarLum1);\r\n\r\n//BarColor\t\t= IIf(Close &gt; Open, UpBarColor, DnBarColor);\r\n//SetBarFillColor(BarColor);\r\nusemethod=ParamToggle("Use H-L or S-R values?","H-L|S-R",1);\r\nPlotg=ParamToggle("Plot Gann lines","No|Yes",1);\r\nPlotmm=ParamToggle("Plot MM lines","No|Yes",0);\r\nmmlum=Param("MM Color Intensity", 0.5, 0, 1,0.1);\r\n\r\nstylecndl=ParamToggle("Bar or Candle chart?","Bar|Candle",0);\r\nShowboll=ParamList("Show Bollinger Bands","Yes|No",1);\r\nresgap=Param("Filter res-supp gap",0,0,30,0.5);\r\n\r\nshowgann=ParamToggle("Show shortest path?","No|Yes",1);\r\nshowrev=ParamToggle("Show Reversal bar?","No|Yes",1);\t\r\nbreakout=ParamToggle("Use breakout condition?","No|Yes",0);\r\niginside=ParamToggle("Ignore inside bars","No|Yes",0);\r\nplotupdnbarc=ParamToggle("Plot Up and Down bar count","No|Yes",0);\r\nOIlogic=ParamToggle("Use open/close logic for trend","No|Yes",0);\r\nGannconsec=ParamToggle("Use consecutive bar logic for trend change","No|Yes",1); \r\ngannbars=Param("N bars = ",2,1,10,1);\r\n\r\nzispace=Param("Kagi line spacing for fixed",0,0,20,1);\r\nkagicam=Paramtoggle("Camarilla On?","No|Yes");\r\nshowkagima=ParamToggle("Show Moving averages ","No|Yes");\r\nkagiperc=Param("Reversal %age units ",0.05,0,1,0.01);\r\nfixedr=ParamList("Reversal Type","Fixed|Variable|PnF",2);\r\npnfrev=Param("PnF reversal bricks",3,1,20,1);\r\nusevar=IIf(fixedr=="Variable",1,0);\r\ngapx=Param("Display Gap",20,0,100,1);\r\nprojected=ParamToggle("Show projected | Estimated signals","No|Yes",1);\r\n\r\nHi=Lo=hi1=lo1=hi2=lo2=fibstat=fibstati=defgap=fdiv1=0;usehl=1;\r\nLine0=Line1=Line2=Line3=Line4=Line5=Line6=Line7=Line8=Lineplus2=Lineminus2=Lineplus1=Lineminus1=Null;\r\nvalabcam=valbelcam=prevxxx=xxx1=0;\r\n\r\nio=O;ic=C;ih=H;il=L;\r\n\r\n\r\n\r\nupbar=downbar=lastlo=lasthi=0;\r\nif (Plotg)\r\n{\r\n\r\n\r\n\r\ntrend=IIf(OIlogic AND iO&lt;iC,1,IIf(OIlogic AND iO&gt;iC,-1,IIf(!OIlogic,0,0)));\r\n}\r\nif (stylecndl)stylec=styleCandle;\r\nelse stylec=styleBar;\r\nsup=res=lastsig=0;\r\nBuy=Short=0;\r\n\r\ngannline=nextsignal=Null;\r\nnextsigc=gannlinebs=barhi=barlo=beglo=beghi=endi=begi=hilo=Lastlo=Lasthi=lastlo1=lasthi1=upbarconsec=downbarconsec=upbari=downbari=lastgann=0;\r\ngann1=gann2=gann1i=gann2i=lastganni=upstarti=downstarti=upbarc=downbarc=ganntrend=0;\r\npk=tr=pki=tri=pkcount=trcount=pktr=pktrcount=lastscore=csi=pkct=trct=cscomp=cbarcount=pktrbar=pktri=0;\r\nch=bh=currhigh=currlow=currvalidbar=Null;\r\npkno=trno=0;\r\nn=1;\r\nbarc=0;\t\r\ncsi=i0=0;\r\ngh1=gl1=gh=gl=lastgh=lastgl=0;\r\ncpk=ctr=cpklast=ctrlast=cpki=ctri=basetrend=0;\r\n//filtering inside bars.\r\n\r\n//Kagi variables\r\nropen=rclose=rhigh=rlow=rdayclose=rdayopen=rdaych1=rdaycl1=rdaych2=rdaycl2=rdtend=Null;rvol=rcolor=revlevel=0;\r\nzOpen=zclose=zHigh=zLow=zdayclose=zdayopen=zdaych1=zdaycl1=zdaych2=zdaycl2=zdate=zyr=zmonth=krsmonth=krsyr=zpkno=zmid=mclose=nclose=oclose=zmaxh=krsh=zminl=krsl=maxh=minl=zminend=zdtend=Null;\r\nzhr=zmin=zdr=zi=zvol=rchk=zm=zdtarray=kstore=lastah=zhrend=rcheck=krscheck=zcheck=zdttime=zdbtime=dttime=dbtime=ztradetime=ztlup=ztldn=ind=0;\r\nVopen=Vclose=Vhigh=Vlow=Null;Vcheck=0;\r\nwOpen=wClose=wHigh=wLow=Null;Vcolor=wcolor=0;\r\n\r\nkminend=kagir=khr=kmin=kagis=krs=krstype=kpktr=krsdate=krsdtend=Null;xdr=krsdtarray=krsvol=krsi=krsct=krct=ksct=kct=kr=ks=krar=ksar=lastsgap=lastrc1=lastrc1i=lastrc2=Lastrc2i=rc1=rc2=0;\r\nlbi1=lbi2=kagicolor=Null;\r\n\r\nkminend=kagir=khr=kmin=kagis=krs=krstype=kpktr=krsdate=krsdtend=Null;xdr=krsdtarray=krsvol=krsi=krsct=krct=ksct=kct=kr=ks=krar=ksar=lastsgap=lastrc1=lastrc1i=lastrc2=Lastrc2i=rc1=rc2=0;\r\nlbi1=lbi2=kagicolor=Null;\r\nkrsmth=revprice=sup=res=0;\r\nostore=jstore=kstore=rdsw=rdct=rind=rdt=ryr=rmth=rhr=rmin=rhrend=rminend=rsec=dayclose=0;\r\nif (showkagima)zispace=0;\r\narray=zi=0;\r\n//kagilinetype=1;\r\nrclin=0;\r\nChecklevel=checkleveli=lastind=0;\r\njn=zispace;\r\npnfmaf=phnfmas=zr1=zr2=zs1=zs2=Null;\r\nbrick=rfac;\r\nif (fixedr=="PnF")fixedrev=brick*pnfrev;\r\npostrade="FR";\r\nintraday=postrade=="INTRA" OR StrLeft(postrade,2)=="FR";\r\n\r\nf1=EMA((iH+iL)/2,avperiod1);\r\nf2=eMA((iH+iL)/2,avperiod2);\r\n\r\nf1H=EMA(iH,avperiod1);\r\nf2H=EMA(iH,avperiod2);\r\nfmafact=2/(avperiod1+1);\r\nsmafact=2/(avperiod2+1);\r\nf1L=EMA(iL,avperiod1);\r\nf2L=EMA(iL,avperiod2);\r\n\r\n\r\nfx=WMA((H+L)/2,avperiod3);\r\nf1f2compi=f2f1compi=f1f2crossi=f2f1crossi=f1f2cross=f2f1cross=0;\r\nHf1f2compi=Hf2f1compi=Hf1f2crossi=Hf2f1crossi=Hf1f2cross=Hf2f1cross=0;\r\nLf1f2compi=Lf2f1compi=Lf1f2crossi=Lf2f1crossi=Lf1f2cross=Lf2f1cross=0;\r\nstdate=stmonth=styear=0;\r\nfor (i=i0;i&lt;BarCount;i++)\r\n{\r\n\tif (ddxbc-ddx[i]&lt;=startx)\r\n\t{\r\n\t\r\n\tif(stdate==0){stdate=dtx[i];stmonth=mth[i];styear=yr[i];}\r\n\t\r\n\t\r\n\tresult=roundx(iH[i],iL[i],i,rfac,0);\r\n\tif (result==0 AND Lastah!=0)\r\n\t{ah[i]=Lastah;al[i]=Lastal;}\r\n\telse {Lastah=ah[i];Lastal=al[i];}\r\n\r\n\tavin[i]=IIf(ah[i]!=0,(ah[i]+al[i])/2,(Lastah+lastal)/2);\r\n\r\nif (usemethod){ch[i]=bh[i]=ah[i];cl[i]=bl[i]=al[i];}\r\nelse {ch[i]=bh[i]=H[i];cl[i]=bl[i]=L[i];}\r\n\r\n\r\n\r\n//day high low logic\r\n\tif (i&gt;0 AND ((showorb=="Single" OR showorb=="Double") OR showcam=="Orb"))\r\n\t{\r\n\t\t\tif (Datey[i]!=Datey[i-1])\r\n\t\t\t{\t\r\n\t\t\t\tprevdayhigh=dayhigh[i-1];\r\n\t\t\t\tprevdaylow=daylow[i-1];\r\n\t\t\t\tDayopen[i]=iO[i];\r\n\t\t\t\tDayclose[i]=iC[i];\r\n\t\t\t\tBuycond=Shortcond=lastsig=0;\r\n\t\t\t\tar1=ar2=ar3=bs1=bs2=bs3=0;\r\n\t\t\t\tfastprice=lev=0;\r\n\t\t\t}\r\n\t\t\tif (Datey[i]==Datey[i-1])\r\n\t\t\t{\r\n\t\t\t\tDayopen[i]=Dayopen[i-1];\r\n\t\t\t\tDayclose[i]=Dayclose[i-1];\r\n\t\t\t\tDayhigh[i]=Dayhigh[i-1];\r\n\t\t\t\tDaylow[i]=Daylow[i-1];\r\n\t\t\t}\r\n\t\t\tif (iH[i]&gt;Dayhigh[i])Dayhigh[i]=iH[i];\r\n\t\t\tif (Daylow[i]==0)Daylow[i]=iL[i];\r\n\t\t\tif (iL[i]&lt;Daylow[i])Daylow[i]=iL[i];\r\n// day high  low logic end\r\n//PlotText(WriteVal(i,1.0),i,H[i]+10,colorWhite);\r\n\r\n\t\tif (tn[i]&lt;timesetting AND (showorb=="Single" OR showorb=="Double"))\r\n\t\t{\r\n//PlotText(WriteVal(1,1.0),i,H[i]+10,colorWhite);\r\n\r\n\t\t\tmline2[i]=r2[i]=Dayhigh[i];\r\n\t\t\tmline4[i]=s2[i]=Daylow[i];\r\n\t\t\tif (showorb=="Single")mline2[i]=fastprice[i]=r2[i]=s2[i]=(Dayhigh[i]+Daylow[i])/2;\r\n\t\t}\r\n\t\telse if (showorb=="Single" OR showorb=="Double") \r\n\t\t{\r\n\r\n\r\n\t\t\tmline2[i]=r2[i]=r2[i-1];\r\n\t\t\tmline4[i]=s2[i]=s2[i-1];\r\n\t\t}\r\n\t\telse if (showcam=="Orb")\r\n\t\t{\r\n\t\t\txdiff=prevdayhigh-prevdaylow;\r\n\t\t\tif (tn[i]&lt;timesetting)xcmid=(dayhigh[i]+daylow[i])/2;\r\n\t\t\t\r\n\t\t\tmline1[i]=r2[i]=(((xdiff)*1.1)/2)+xcmid;\r\n\t\t\tmline2[i]=r1[i]=(((xdiff)*1.1)/4)+xcmid;\r\n\t\t\tmline3[i]=s1[i]=(xcmid-((xdiff)*1.1)/4);\r\n\t\t\tmline4[i]=s2[i]=(xcmid-((xdiff)*1.1)/2);\r\n\t\t\tif (showmid)mline5[i]=(mline2[i]+mline3[i])/2;\r\n\t\t}\r\n\r\n\t}\r\n\r\n\r\n\t\r\n\r\n\r\n//if(i==sbb[i])PlotText(WriteVal(xxh[i],1.0),i,H[i]+10,colorWhite);\r\n//if(i==BarCount-1)PlotText(WriteVal(1,1.0),i,H[i]+10,colorWhite);\r\n\r\n\r\n\r\n\r\n//\r\nif (ah[i]&gt;mline1[i] AND al[i]&lt;mline1[i])cline=mline1[i];\r\nelse if (ah[i]&gt;mline2[i] AND al[i]&lt;mline2[i])cline=mline2[i];\r\nelse if (ah[i]&gt;mline3[i] AND al[i]&lt;mline3[i])cline=mline3[i];\r\nelse if (ah[i]&gt;mline4[i] AND al[i]&lt;mline4[i])cline=mline4[i];\r\n//Rounding end\r\n//additional SR lines\r\nif (fillerbar)\r\n{\r\n\r\nfdiv=round(((ah[i]-al[i])/rfac));\r\nfdiv1=IIf(fdiv&gt;=2,fdiv-1,0);\r\n//PlotText(WriteVal(fdiv,1.2),i,H[i]+15,colorOrange);\r\nif (fdiv&gt;0)\r\n{\r\n\r\n\tfdiv1=fdiv-1;\r\n\tif (fdiv1&gt;srn)fdiv=srn;\r\n\tfor (j=1;j&lt;=fdiv1;j++)\r\n\t{\r\n\t\t/*if (j==1)sr1[i]=al[i]+j*rfac;\t\r\n\t\telse if (j==2)sr2[i]=al[i]+j*rfac;\r\n\t\telse if (j==3)sr3[i]=al[i]+j*rfac;\r\n\t\telse if (j==4)sr4[i]=al[i]+j*rfac;\r\n\t\telse if (j==5)sr5[i]=al[i]+j*rfac;\r\n\t\telse if (j==6)sr6[i]=al[i]+j*rfac;\r\n\t\telse if (j==7)sr7[i]=al[i]+j*rfac;\r\n\t\telse if (j==8)sr8[i]=al[i]+j*rfac;\t\r\n\t\telse if (j==9)sr9[i]=al[i]+j*rfac;\r\n\t\telse if (j==10)sr10[i]=al[i]+j*rfac;\r\n\t\telse if (j==11)sr11[i]=al[i]+j*rfac;\r\n\t\telse if (j==12){xxx=VarGet("sr"+j);xxx[i]=al[i]+j*rfac;VarSet("sr"+j,xxx);}*/\r\n\t\tif (j==1)prevxxx=al[i];\r\n\t\telse prevxxx=xxx1;\r\n\t\txxx=VarGet("sr"+j);xxx1=xxx[i]=al[i]+j*rfac;VarSet("sr"+j,xxx);\r\n\t\tif (xxx1&gt;cline AND prevxxx&lt;cline){valabcam=xxx1; valbelcam=prevxxx;}\r\n\t\t\r\n\t}\r\n\t\r\n}\r\n\r\n}\r\nv1[i]=valabcam;\r\nv2[i]=valbelcam;\r\n//if (i==sbb[i])PlotText(WriteVal(cline[i],1.0),i,H[i]+2*tr[i],colorWhite);\r\n\r\n\r\nif (Plotg)\r\n{\r\n\r\n\r\n\r\n//inside bar outside bars\r\n\r\nif (i&gt;i0 )\r\n{\r\n\tif (iginside)//ignore inside bars\r\n\t{\r\n\t\t\r\n\t\tif (i-csi&gt;=n ) //Ignore bars that have null ah and al, possible in bar 0\r\n\t\t{\r\n\t\t\tif(cscomp&gt;0)csi=cscomp;\t\r\n\t\t\t//PlotText(WriteVal(cscomp,1.0),i,H[i]+15,colorOrange);\r\n\t\t\tif (ah[i]&gt;ah[csi] OR al[i]&lt;al[csi])\r\n\t\t\t{\r\n\t\t\t\tcscomp=i;\r\n\t\t\t\t//if (i==sbb[i])\r\n\t\t\t\t//PlotText(WriteVal(cscomp-csi,1.0),i,H[i]+15,colorOrange);\r\n\t\t\t}\t\r\n\t\t}\r\n\t}\r\n\telse if (i&gt;=n)//do not ignore inside bars\r\n\t{\r\n\t\tcscomp=i;csi=i-n;\r\n\t}\r\n}\r\n//PlotText(WriteVal(csi,1.0),i,H[i]+15,colorOrange);\r\n\r\n\r\nif (i&gt;=gannbars AND i==cscomp AND i&gt;=i0)\r\n{\r\n//if (i&gt;begi+1)PlotText(WriteVal(I&gt;begi+1,1.0),i,H[i]+15,colorOrange);\t\r\n\t\r\n\tif (bh[i]&gt;bh[csi] AND trend[i]&gt;=0)upbarconsec=1;\r\n\telse if(bh[i]&lt;bh[csi] AND upbar&lt;gannbars)upbar=upbarconsec=0;\r\n\t//else if(bh[i]&lt;bh[csi] AND trend[i]&gt;=0 AND upbar&lt;gannbars)upbar=upbarconsec=0;\r\n\tif (bl[i]&lt;bl[csi] AND trend[i]&lt;=0)downbarconsec=1;\r\n\telse if (bl[i]&gt;bl[csi] AND downbar&lt;gannbars)downbar=downbarconsec=0;\r\n\t//else if (bl[i]&gt;bl[csi] AND trend[i]&lt;=0 AND downbar&lt;gannbars)downbar=downbarconsec=0;\r\n\r\n\tif (((upbar&lt;gannbars AND bh[i]&gt;bh[csi] AND trend[i]&gt;=0 AND upbarconsec==1) OR (breakout AND bh[i]&gt;bh[beghi]))\r\n\t\t\tOR ((upbar&gt;=gannbars AND bh[i]&gt;bH[upbari] AND bh[i]&gt;Lastgann) AND bh[i]&gt;bh[csi] AND trend[i]&gt;=0) )\r\n\r\n\t{\r\n\t//PlotText(WriteVal(csi,1.0),i,H[i]+15,colorOrange);\r\n\t\tupbar=upbar+1;upbari=i;\r\n\t\tif ((upbar&gt;=gannbars AND i&gt;beglo ) OR (breakout AND bh[i]&gt;bh[beghi]))\r\n\t\t{\r\n\t\t\tif (((beghi&gt;beglo AND bh[i]&gt;bh[beghi]) OR beghi==0) OR beglo&gt;beghi)\r\n\t\t\t{\r\n\t\t\t\tdownbar=downbarconsec=0;\r\n\t\t\t\tgann2=gann1;gann1=Lastgann;\r\n\t\t\t\tgann2i=gann1i;gann1i=Lastganni;\r\n\t\t\t\tlastgann=gannline[i]=bh[i];\r\n\t\t\t\tbarhi=1;\r\n\t\t\t\tbarlo=0;\r\n\t\t\t\tprevhi=beghi;\r\n\t\t\t\tlastganni=beghi=i;\r\n\t\t\t\tif ((bh[beghi]&gt;bh[prevhi] AND prevhi&gt;beglo) OR beglo&gt;prevhi)\t{lasthi1=Lasthi;Lasthi=i;}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\n\tif (((downbar&lt;gannbars AND bl[i]&lt;bl[csi]  AND trend[i]&lt;=0 AND downbarconsec==1) OR (breakout AND bl[i]&lt;bl[beglo] AND i!=beghi))\r\n\t\tOR ((downbar&gt;=gannbars AND bl[i]&lt;bL[downbari]) AND bl[i]&lt;bl[csi] AND trend[i]&lt;=0))\r\n\r\n\t{\r\n\t\tdownbar=downbar+1;downbari=i;\r\n\t\tif ((downbar&gt;=gannbars AND i&gt;beghi AND (bl[i]&lt;Lastgann OR lastgann==0) )  OR (breakout AND bl[i]&lt;bl[beglo] AND i!=beghi))\r\n\t\t{\r\n\t\t\tif (((beglo&gt;beghi AND bl[i]&lt;bl[beglo]) OR beglo==0 ) OR beghi&gt;beglo)\r\n\t\t\t{\r\n\t\t\t\tupbar=upbarconsec=0;\r\n\t\t\t\tgann2=gann1;gann1=Lastgann;\r\n\t\t\t\tgann2i=gann1i;gann1i=Lastganni;\r\n\t\t\t\tlastgann=gannline[i]=bl[i];\r\n\t\t\t\tbarlo=1;\r\n\t\t\t\tbarhi=0;\r\n\t\t\t\tprevlo=beglo;\r\n\t\t\t\tif (beglo==0 AND lastganni&gt;0)beglo=lastganni;\r\n\t\t\t\tlastganni=beglo=i;\r\n\t\t\t\tif ((bl[beglo]&lt;bl[prevlo] AND prevlo&gt;beghi) OR beghi&gt;prevlo){lastlo1=lastlo;Lastlo=i;}\r\n\t\t\t}\r\n\t\t}\r\n\t}\r\n\r\nif (showrev AND plotsrchart)\r\n{\r\n\tbarc[i]=IIf(upbar&gt;0 AND (upbar&gt;=gannbars OR (upbar==1 AND gannline[i]&gt;0) ),1,IIf(downbar&gt;0 AND (downbar&gt;=gannbars OR (downbar==-1 AND gannline[i]&gt;0)),-1,0));\r\n\tif (i&gt;0 AND barc[i]!=barc[csi] AND barc[i]==1)PlotText("X",i,H[i]+rfac,colorgreen);\t\r\n\telse if (i&gt;0 AND barc[i]!=barc[csi] AND barc[i]==-1)PlotText("X",i,L[i]-2*rfac,colorOrange);\t\r\n\t//PlotText(WriteVal(downbar,1.),i,h[i]+5*rfac,colorOrange);\r\n}\r\nif (i&gt;i0 AND beglo&gt;i0 AND beghi&gt;i0)\r\n{\r\n\tif (i==beglo)\r\n\t{\r\n\r\n\t\tif (prevlo&gt;beghi)\r\n\t\t{\r\n\t\t\tif (showgann==0){begi=prevlo; begval=bl[prevlo];}\r\n\t\t\telse {begi=Lasthi; begval=bh[lasthi];}\r\n\t\t\tendi=beglo;endval=bl[beglo];\r\n\t\t}\r\n\t\telse if (beghi&gt;prevlo)\r\n\t\t{\r\n\r\n\t\t\tif (showgann==0){begi=beghi; begval=bh[beghi];}\r\n\t\t\telse {begi=Lasthi; begval=bh[lasthi];}\r\n\t\t\tendi=beglo;endval=bl[beglo];\r\n\t\t}\r\n\t}\r\n\tif (i==beghi)\r\n\t{\r\n\t\tif (prevhi&gt;beglo)\r\n\t\t{\r\n\t\t\tif (showgann==0){begi=prevhi; begval=bh[prevhi];}\r\n\t\t\telse {begi=Lastlo; begval=bl[Lastlo];}\r\n\r\n\t\t\tendi=beghi;endval=bh[beghi];\r\n\t\t}\r\n\t\telse if (beglo&gt;prevhi)\r\n\t\t{\r\n\t\t\tif (showgann==0){begi=beglo; begval=bl[beglo];}\r\n\t\t\telse {begi=Lastlo; begval=bl[Lastlo];}\r\n\t\t\tendi=beghi;endval=bh[beghi];\r\n\t\t}\r\n\t}\r\n\r\n\tif (endi-begi&gt;1)\r\n\t{\r\n\t\tincr=(endval-begval)/(endi-begi);\r\n\t\tfor (kg=begi;kg&lt;=endi;kg++)\r\n\t\t{\r\n\t\t\tgannline[kg]=begval+(kg-begi)*incr;\r\n\t\t}\r\n\t}\t\r\n\r\n}\r\n//Peaks and troughs\r\nif (gannline[i] AND gann1&gt;Lastgann AND gann1&gt;gann2)\r\n{\r\n\tpkcount=pkcount+1;pktrcount=pktrcount+1;pktr[pktrcount]=pk[pkcount]=gann1;pktri[pktrcount]=pki[pkcount]=gann1i;\r\n\tif (pktrcount&gt;1)\r\n\t{\r\n\t\tind=ind+1;\r\n\t\trhigh[ind]=rclose[ind]=pktr[pktrcount];\r\n\t\trlow[ind]=ropen[ind]=pktr[pktrcount-1];\r\n\t\tmaxh[ind]=Max(maxh[ind],H[pktri[pktrcount]]);\r\n\t\tmaxh[ind]=Max(maxh[ind],H[i]);\r\n\t\tminl[ind]=Min(IIf(minl[ind]==0,L[pktri[pktrcount]],minl[ind]),L[pktri[pktrcount]]);\r\n\t\tminl[ind]=Min(minl[ind],L[i]);\r\n\t\tryr[ind]=IIf(ryr[ind]==0,yr[pktri[pktrcount]],ryr[ind]);\r\n\t\trmth[ind]=IIf(rmth[ind]==0,mth[pktri[pktrcount]],rmth[ind]);\r\n\t\trdt[ind]=IIf(rdt[ind]==0,dtx[pktri[pktrcount]],rdt[ind]);\r\n\t\trhr[ind]=IIf(rhr[ind]==0,hr[pktri[pktrcount]],rhr[ind]);\r\n\t\trmin[ind]=IIf(rmin[ind]==0,mn[pktri[pktrcount]],rmin[ind]);\r\n\t\t\r\n\t}\r\n}\r\nelse if (gannline[i] AND gann1&lt;Lastgann AND gann1&lt;gann2)\r\n{\r\n\ttrcount=trcount+1;pktrcount=pktrcount+1;pktr[pktrcount]=tr[trcount]=gann1;pktri[pktrcount]=tri[trcount]=gann1i;\r\n\tif (pktrcount&gt;1)\r\n\t{\r\n\t\tind=ind+1;\r\n\t\trlow[ind]=rclose[ind]=pktr[pktrcount];\r\n\t\trhigh[ind]=ropen[ind]=pktr[pktrcount-1];\r\n\t\tmaxh[ind]=Max(maxh[ind],H[pktri[pktrcount]]);\r\n\t\tmaxh[ind]=Max(maxh[ind],H[i]);\r\n\t\tminl[ind]=Min(IIf(Nz(minl[ind+rclin])==0,L[pktri[pktrcount]],minl[ind]),L[pktri[pktrcount]]);\r\n\t\tminl[ind]=Min(minl[ind],L[i]);\r\n\t\tryr[ind]=IIf(ryr[ind]==0,yr[pktri[pktrcount]],ryr[ind]);\r\n\t\trmth[ind]=IIf(rmth[ind]==0,mth[pktri[pktrcount]],rmth[ind]);\r\n\t\trdt[ind]=IIf(rdt[ind]==0,dtx[pktri[pktrcount]],rdt[ind]);\r\n\t\trhr[ind]=IIf(rhr[ind]==0,hr[pktri[pktrcount]],rhr[ind]);\r\n\t\trmin[ind]=IIf(rmin[ind]==0,mn[pktri[pktrcount]],rmin[ind]);\r\n\t}\r\n}\r\nif (lastganni&gt;pktri[pktrcount] AND !IsNull(gannline[i]))\r\n{\r\n\trclin=1;\r\n\tif (gannline[i]&gt;rclose[ind])\r\n\t{\r\n\t\trclose[ind+rclin]=rhigh[ind+rclin]=gannline[i];\r\n\t\trlow[ind+rclin]=ropen[ind+rclin]=rclose[ind];\r\n\t}\r\n\telse if (gannline[i]&lt;rclose[ind])\r\n\t{\r\n\t\trclose[ind+rclin]=rlow[ind+rclin]=gannline[i];\r\n\t\trhigh[ind+rclin]=ropen[ind+rclin]=rclose[ind];\r\n\t}\r\n\tmaxh[ind+rclin]=Max(maxh[ind+rclin],H[i]);\r\n\tminl[ind+rclin]=Min(IIf(Nz(minl[ind+rclin])==0,L[i],minl[ind+rclin]),L[i]);\r\n\tryr[ind+rclin]=IIf(ryr[ind+rclin]==0,yr[i],ryr[ind+rclin]);\r\n\trmth[ind+rclin]=IIf(rmth[ind+rclin]==0,mth[i],rmth[ind+rclin]);\r\n\trdt[ind+rclin]=IIf(rdt[ind+rclin]==0,dtx[i],rdt[ind+rclin]);\r\n\trhr[ind+rclin]=IIf(rhr[ind+rclin]==0,hr[i],rhr[ind+rclin]);\r\n\trmin[ind+rclin]=IIf(rmin[ind+rclin]==0,mn[i],rmin[ind+rclin]);\r\n\t\r\n\r\n}\r\nelse rclin=0;\t\r\n\t\r\nif (pktrcount&gt;1 AND pktr[pktrcount]&gt;pktr[pktrcount-1])Lastscore[i]=pktr[pktrcount]-pktr[pktrcount-1];\r\nelse if (pktrcount&gt;1 AND pktr[pktrcount]&lt;pktr[pktrcount-1])Lastscore[i]=pktr[pktrcount-1]-pktr[pktrcount];\r\n//if (i==sbb[i])PlotText(WriteVal(rclose[ind],1.0),i,High[i]+10,colorWhite);\r\n//Lastscore[i]=pk[pkcount]-tr[trcount];\r\n//if (pktrcount&gt;2)PlotText(WriteVal(Lastscore[i],1.0),i,H[i]+2*pgap[i],colorYellow);\r\n//trend line end\r\n}\r\n}\r\nif (i&gt;0 AND pkcount&gt;0 AND trcount&gt;0)\r\n{\r\n\tcpk=pk[pkcount];cpki=pki[pkcount];cpklast=pk[pkcount-1];cpklasti=pki[pkcount-1];\r\n\tctr=tr[trcount];ctri=tri[trcount];ctrlast=tr[trcount-1];ctlastri=tri[trcount-1];\r\n\t/*if (( (cpk&lt;cpklast AND ctr&lt;ctrlast) OR (cpk==cpklast AND ctr&lt;=ctrlast) OR (il[i]==ctr-rfac) )\r\n\t\t\tAND cpki&gt;ctri AND gannline[i]&lt;gannline[i-1])basetrend[i]=IIf(showauto,-2,0);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\telse if ( ((ctr&gt;ctrlast AND cpk&gt;cpklast ) OR (ctr==ctrlast AND cpk&gt;=cpklast) OR (ih[i]==cpk+rfac)) \r\n\t\t\tAND ctri&gt;cpki AND gannline[i]&gt;gannline[i-1])basetrend[i]=IIf(showauto,1,0);//(lastsig!=1 OR exitsigi&gt;lastsigi) AND*/\r\n\r\n\r\n\t\r\n\tif (plotsrchart)\r\n\t{\r\n\t\tif (pkno!=pkcount){PlotText(WriteIf(cpk&gt;cpklast,"HH",WriteIf(cpk==cpklast,"DT",WriteIf(cpk&lt;cpklast,"LH",""))),pki[pkcount],gannline[pki[pkcount]]+rfac,ColorRGB(75,75,75));pkno=pkcount;}\r\n\t\tif (trno!=trcount){PlotText(WriteIf(ctr&gt;ctrlast,"HL",WriteIf(ctr==ctrlast,"DB",WriteIf(ctr&lt;ctrlast,"LL",""))),tri[trcount],gannline[tri[trcount]]-rfac,ColorRGB(75,75,75));trno=trcount;}\r\n\t}\t\r\n}\r\nupbarc[i]=upbar;\r\ndownbarc[i]=downbar;\r\nif (plotupdnbarc)\r\n{\r\n\tIf(downbar!=0)PlotText(WriteVal(downbar,1.),i,il[i]-3*rfac,colorOrange);\r\n\tif(upbar!=0)PlotText(WriteVal(upbar,1.),i,iH[i]+3*rfac,colorgreen);\r\n}\r\nif (upbarc[i]==gannbars-1 AND I&gt;0 AND upbarc[i]&gt;upbarc[i-1]){upstarti=i;nextsigc[i]=1;nextsignal[i]=ah[upstarti]+rfac;}\r\nif (downbarc[i]==gannbars-1 AND I&gt;0 AND downbarc[i]&gt;downbarc[i-1]){downstarti=i;nextsigc[i]=-1;nextsignal[i]=al[downstarti]-rfac;}\r\n\r\nif (i&gt;0 AND nextsigc[i]==0)\r\n{\r\n\tnextsigc[i]=nextsigc[i-1];\r\n\tif (upbar==0 AND downbar&gt;0)nextsigc[i]=-1;\r\n\tif (downbar==0 AND upbar&gt;0)nextsigc[i]=1;\r\n}\r\n\r\n\t\r\nif (nextsigc[i]==1 AND i&gt;upstarti)nextsignal[i]=nextsignal[upstarti];\r\nelse if (nextsigc[i]==-1 AND i&gt;downstarti)nextsignal[i]=nextsignal[downstarti];\r\n\r\npktrbar[i]=pktrcount;\r\n//if (gannline[i]==0)gannline[i]=Null;\r\n\r\nif (i==sbb[i])PlotText(Writeif(basetrend[i]==1,"UP",WriteIf(basetrend[i]==-2,"DN","")),i,H[i]+rfac1/2,ColorRGB(75,75,0));\r\n\r\n//Buy Sell signals\r\n\t//\r\n\tif (!IsNull(gannline[i]))\r\n\t{\r\n\t\tif(gannline[i]&lt;gannline[i-1])ganntrend=-1;\r\n\t\telse if (gannline[i]&gt;gannline[i-1])ganntrend=1;\t\r\n\t}\r\n\tjstore[i]=i;\r\n\tVarname = Name()+chid+yr[i]+mth[i]+dtx[i]+Hr[i]+mn[i];\r\n\tsig=StaticVarGet(Varname);\r\n\t\r\n\tif (IsNull(sig))sig1=0;\r\n\tif (sig==5){PlotText("S-ON",i,H[i]+2*rfac,colorYellow);suppon=1;}\r\n\tif (sig==-5){PlotText("S-OFF",i,H[i]+2*rfac,colorYellow);suppon=0;}\r\n\tcurdate=(yr[i]%100)*10000+mth[i]*100+dtx[i];\r\n\t\r\n\r\n\tupgap=IIf(hhl,ah[i]-f2H[i],ah[i]-f2l[i]);\r\n\tdowngap=IIf(hhl,f2L[i]-al[i],f2h[i]-al[i]);\r\n\t\r\n\t\r\n\r\n\tif (i&gt;1)\r\n\t{\r\n\t\t\r\n\t\tix=i;\r\n\t\t/*if (f1[ix]&gt;f2[ix] AND f1[ix-1]&lt;=f2[ix-1]){f1f2cross=1;f2f1cross=0;f1f2compi=i;}\r\n\t\tif (f1[ix]&lt;f2[ix] AND f1[ix-1]&gt;=f2[ix-1]){f2f1cross=1;f1f2cross=0;f2f1compi=i;}*/\r\n\t\tif (hhl)\r\n\t\t{\r\n\t\t\tif (f1H[ix]&gt;f2H[ix] AND f1H[ix-1]&lt;=f2H[ix-1]){f1f2cross=1;f2f1cross=f2f1crossi=0;f1f2compi=i;}\r\n\t\t\tif (f1L[ix]&lt;f2L[ix] AND f1L[ix-1]&gt;=f2L[ix-1]){f2f1cross=1;f1f2cross=f1f2crossi=0;f2f1compi=i;}\r\n\t\t}\r\n\t\telse \r\n\t\tif (!hhl)\r\n\t\t{\r\n\t\t\tif (f1H[ix]&lt;f2H[ix] AND f1H[ix-1]&gt;=f2H[ix-1]){f2f1cross=1;f1f2cross=f1f2crossi=0;f2f1compi=i;}\r\n\t\t\tif (f1L[ix]&gt;f2L[ix] AND f1L[ix-1]&lt;=f2L[ix-1]){f1f2cross=1;f2f1cross=f2f1crossi=0;f1f2compi=i;}\r\n\t\t}\r\n\t\t\r\n\r\n\t\tif (maadj AND madist==0)\r\n\t\t{\r\n\t\t\tif (f1f2cross AND i==f1f2compi+1)f1f2crossi=i;\r\n\t\t\tif (f2f1cross AND i==f2f1compi+1)f2f1crossi=i;\r\n\t\t\r\n\t\t}\r\n\t\tif (madist&gt;0 AND !maadj)\r\n\t\t{\r\n\t\t\t//if (f1f2cross AND i&gt;=f1f2compi AND f1[i]-f2[i]&gt;=madist)f1f2crossi=i;\r\n\t\t\t//if (f2f1cross AND i&gt;=f2f1compi AND f2[i]-f1[i]&gt;=madist)f2f1crossi=i;\r\n\t\t\tif (f1f2cross AND i&gt;=f1f2compi AND upgap&gt;=madist AND f1f2crossi==0)f1f2crossi=i;\r\n\t\t\tif (f2f1cross AND i&gt;=f2f1compi AND downgap&gt;=madist AND f2f1crossi==0)f2f1crossi=i;\r\n\t\t}\r\n\t\tif (madist&gt;0 AND maadj)\r\n\t\t{\r\n\t\t\t//if (f1f2cross AND ((i&gt;=f1f2compi AND f1[i]-f2[i]&gt;=madist) OR (i&gt;=f1f2compi+1 AND f1[i]-f2[i]&gt;=madist)))f1f2crossi=i;\r\n\t\t\t//if (f2f1cross AND ((i&gt;=f2f1compi AND f2[i]-f1[i]&gt;=madist) OR (i&gt;=f2f1compi+1 AND f2[i]-f1[i]&gt;=madist)))f2f1crossi=i;\r\n\t\t\tif (f1f2cross AND ((i&gt;=f1f2compi AND upgap&gt;=madist) OR (i&gt;=f1f2compi+1 AND upgap&gt;=madist)))f1f2crossi=i;\r\n\t\t\tif (f2f1cross AND ((i&gt;=f2f1compi AND downgap&gt;=madist) OR (i&gt;=f2f1compi+1 AND downgap&gt;=madist)))f2f1crossi=i;\r\n\r\n\r\n\t\t}\r\n\t\tif (madist==0 AND !maadj)\r\n\t\t{\r\n\t\t\tif (f1f2cross AND i==f1f2compi)f1f2crossi=i;\r\n\t\t\tif (f2f1cross AND i==f2f1compi)f2f1crossi=i;\r\n\t\t}\r\n\r\n\t\t\r\n\t}\r\n\r\n\t\r\n\t\t\t\r\n\r\n\r\n\tigap=IIf(lastsig==1 AND hhl,f1l[i]-f2l[i],IIf(lastsig==-2 AND hhl,f1h[i]-f2h[i],IIf(lastsig==1 AND !hhl, f1h[i]-f2h[i],IIf(lastsig==-2,f1l[i]-f2l[i],0))));\r\n\tforecasttype=forecastlong=forecastshort=0;\r\n\t//if (f1f2cross)nshort=IIf(hhl,f2l[f2f1crossi]-madist,f2h[f2f1crossi]-madist);\r\n\t//if (f2f1cross)nlong=IIf(hhl,f2h[f1f2crossi]+madist,f2l[f1f2crossi]+madist);\r\n\r\n\tif (i&gt;0)\r\n\t{\r\n\t\tif (f2f1cross)\r\n\t\t{\r\n\t\t\tnshort=IIf(hhl,f2l[f2f1crossi]-madist,f2h[f2f1crossi]-madist);\r\n\t\t\tforecastlong=fsamebarl=IIf(hhl,IIf((f2f1cross AND f1h[i]&lt;f2h[i]) OR !f1f2cross,(f2h[i-1]-f1h[i-1]*(1-fmafact))/fmafact,0),\r\n\t\t\t\tIIf((f2f1cross AND f1l[i]&lt;f2l[i]) OR !f1f2cross,(f2l[i-1]-f1l[i-1]*(1-fmafact))/fmafact,0));\r\n\t\t\tfnextbarl=IIf(hhl,IIf((f2f1cross AND f1h[i]&lt;f2h[i]) OR !f1f2cross,ih[i]+(f2h[i]-f1h[i])/fmafact,0),\r\n\t\t\t\tIIf((f2f1cross AND f1l[i]&lt;f2l[i]) OR !f1f2cross,ih[i]+(f2l[i]-f1l[i])/fmafact,0));\r\n\t\t\t\t\r\n\t\t\tlongqual=ah[i]+rfac;\r\n\t\t\t\r\n\t\t\tif (fsamebarl&gt;=longqual AND fnextbarl&gt;=longqual)forecastlong=Min(fsamebarl,fnextbarl);\r\n\t\t\telse if (fsamebarl&gt;=longqual AND fnextbarl&lt;longqual)forecastlong=fsamebarl;\r\n\t\t\telse if (fnextbarl&gt;=longqual AND fsamebarl&lt;longqual)forecastlong=fnextbarl;\r\n\t\t\telse forecastlong=longqual;\r\n\t\t\tznextlong[i]=projlong=IIf(hhl,IIf(f1h[i]&lt;f2h[i],forecastlong,0),IIf(f1l[i]&lt;f2l[i],forecastlong,0));\t\r\n\t\t\r\n\t\t\tif (i==sbb[i])PlotText("SB"+WriteVal(fsamebarl,1.2,0)+"/"+WriteVal(fsamebarl-xh[i]&gt;rfac,1),i,iH[i]+10*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("NB"+WriteVal(fnextbarl,1.2,0)+"/"+WriteVal(fnextbarl-xh[i]&gt;rfac,1),i,iH[i]+8*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("NL"+WriteVal(znextlong[i-1],1.2,0)+"/"+WriteVal(znextlong[i]-xh[i]&gt;rfac,1),i,iH[i]+6*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("XQ"+WriteVal(ah[i]+rfac,1.2,0)+"/"+WriteVal(forecastlong,1.2,0),i,iH[i]+4*gapx,colorWhite);\t\t\r\n\t\t\t//WriteVal(IIf(hhl,f2h[i],f2l[i]),1.2,0),i,iH[i]+2*gapx,colorWhite);\t\t\r\n\t\t}\r\n\t\telse if (f1f2cross)\r\n\t\t{\r\n\t\t\tnlong=IIf(hhl,f2h[f1f2crossi]+madist,f2l[f1f2crossi]+madist);\r\n\t\t\tfsamebars=IIf( hhl,IIf((f1f2cross AND f1l[i]&gt;f2l[i]) OR !f2f1cross,(f2l[i-1]-f1l[i-1]*(1-fmafact))/fmafact,0),\t\t\t\r\n\t\t\t\t\tIIf((f1f2cross AND f1h[i]&gt;f2h[i]) OR !f2f1cross,(f2h[i-1]-f1h[i-1]*(1-fmafact))/fmafact,0));\t\r\n\t\t\r\n\r\n\t\t\tfnextbars=IIf( hhl,IIf((f1f2cross AND f1l[i]&gt;f2l[i]) OR !f2f1cross,il[i]-(f1l[i]-f2l[i])/fmafact,0),\t\t\t\r\n\t\t\t\t\tIIf((f1f2cross AND f1h[i]&gt;f2h[i]) OR !f2f1cross,il[i]-(f1h[i]-f2h[i])/fmafact,0));\t\r\n\r\n\t\t\tshortqual=al[i]-rfac;\r\n\t\t\tif (fsamebars&lt;=shortqual AND fnextbars&lt;=shortqual)forecastshort=Max(fsamebars,fnextbars);\r\n\t\t\telse if (fsamebars&gt;=shortqual AND fnextbars&lt;shortqual)forecastshort=fsamebars;\r\n\t\t\telse if (fnextbars&gt;=shortqual AND fsamebars&lt;shortqual)forecastshort=fnextbars;\r\n\t\t\telse forecastshort=shortqual;\r\n\t\t\tznextshort[i]=projshort=IIf(hhl,IIf(f1l[i]&gt;f2l[i],forecastshort,0),IIf(f1h[i]&gt;f2h[i],forecastshort,0));\r\n\t\t\t\r\n\t\t\tif (i==sbb[i])PlotText("SB"+WriteVal(fsamebars,1.2,0)+"/"+WriteVal(xl[i]-fsamebars&gt;rfac,1),i,iH[i]+10*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("NB"+WriteVal(fnextbars,1.2,0)+"/"+WriteVal(xl[i]-fnextbars&gt;rfac,1),i,iH[i]+8*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("NS"+WriteVal(znextshort[i-1],1.2,0)+"/"+WriteVal(xl[i]-znextshort[i]&gt;rfac,1),i,iH[i]+6*gapx,colorWhite);\t\r\n\t\t\tif (i==sbb[i])PlotText("XQ"+WriteVal(al[i]-rfac,1.2,0)+"/"+WriteVal(forecastshort,1.2,0),i,iH[i]+4*gapx,colorWhite);\t\r\n\t\t\t\r\n\t\t\t//if (i==sbb[i])PlotText(WriteVal(fs,1.2,0),i,iH[i]+2*gapx,colorWhite);\t\r\n\t\t}\r\n\t\t\r\n\t\t\r\n\t\t//znextshort[i]=projshort=IIf(f1l[i]&gt;f2l[i] AND ganntrend==-1,forecastshort,0);\r\n\t\t//znextlong[i]=projlong=IIf(f1h[i]&lt;f2h[i] AND ganntrend==1,forecastlong,0);\r\n\r\n\t\tznextshort[i]=projshort=IIf(hhl,IIf(f1l[i]&gt;f2l[i],forecastshort,0),IIf(f1h[i]&gt;f2h[i],forecastshort,0));\r\n\t\tznextlong[i]=projlong=IIf(hhl,IIf(f1h[i]&lt;f2h[i],forecastlong,0),IIf(f1l[i]&lt;f2l[i],forecastlong,0));\r\n\r\n\t\tif (projected)\r\n\t\t{\r\n\t\t\tif (znextlong[i-1]&gt;0)nlong=znextlong[i-1];\r\n\t\t\tif (znextshort[i-1]&gt;0)nshort=znextshort[i-1];\r\n\t\t}\r\n\t\t//if (i==sbb[i])PlotText("XQ"+WriteVal(xl[i]-rfac,1.2,0)+"/"+WriteVal(nshort,1.2,0),i,iH[i]+2*gapx,colorWhite);\t\r\n\t\t//if (i==sbb[i])PlotText(WriteVal(f2f1cross,1.2),i,iH[i]+rfac,colorWhite);\t\r\n\t\tznextlongsl[i]=IIf (znextlong[i]!=0,znextlong[i]-(ctr-rfac),0);\r\n\t\tznextshortsl[i]=IIf (znextshort[i]!=0,cpk+rfac-znextshort[i],0);\r\n\t\tznextlongslval[i]=IIf (znextlong[i]!=0,znextlong[i]-(ctr-rfac),0);\r\n\t\tznextshortsl[i]=IIf (znextshort[i]!=0,cpk+rfac-znextshort[i],0);\r\n\t}\r\n\t\r\n\t//project highs and lows for next cross over\r\n\t\r\n\r\n\tif (showauto AND !suppon AND tn[i]!=091500 AND  (useautorange==0 OR (useautorange==1 AND curdate&gt;=autodatestart AND curdate&lt;=autodateend)))\r\n\t{\r\n\t\tactivebuy=lastsig==1 AND lastsigi&gt;exiti;\r\n\t\treentry=1;\r\n\r\n\t\tif (trademode=="SR-Swing")\r\n\t\t{\t\r\n\t\t\tif (cpk&lt;cpklast AND al[i]&lt;=ctr-rfac AND cpki&gt;ctri AND ganntrend==-1 )basetrend[i]=sig=\r\n\t\t\t\tIIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (ctr&gt;ctrlast AND ah[i]&gt;=cpk+rfac  AND ctri&gt;cpki AND ganntrend==1)basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\t\tif (trademode=="SR-Break")\r\n\t\t{\t\r\n\t\t\tif (al[i]&lt;=ctr-rfac AND ganntrend==-1)basetrend[i]=sig=\r\n\t\t\t\tIIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (ah[i]&gt;=cpk+rfac AND ganntrend==1)basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\t\tif (trademode=="MA-Cross")\r\n\t\t{\t\r\n\t\t\tif (f2f1cross AND (i-f2f1crossi&lt;=crosslim OR (reentry AND i-f1f2crossi&gt;crosslim AND lastsig==-1 AND exitintraday)) AND ganntrend==-1 AND il[i]&lt;=nshort)basetrend[i]=sig=\r\n\t\t\t\tIIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (f1f2cross AND (i-f1f2crossi&lt;=crosslim OR (reentry AND i-f1f2crossi&gt;crosslim AND lastsig==1 AND exitintraday)) AND ganntrend==1 AND ih[i]&gt;=nlong)basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\t\telse if (trademode=="Retrace")\r\n\t\t{\t\r\n\t\t\tif (cpk&lt;cpklast AND cpki&gt;ctri AND gannline[i]&lt;gannline[i-1])basetrend[i]=sig=IIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (ctr&gt;ctrlast AND ctri&gt;cpki AND gannline[i]&gt;gannline[i-1])basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\t\telse if (trademode=="MA-Retrace")\r\n\t\t{\t\r\n\t\t\tif (cpk&lt;cpklast AND cpki&gt;ctri AND gannline[i]&lt;gannline[i-1] AND f2f1cross AND i-f2f1crossi&lt;=crosslim)basetrend[i]=IIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (ctr&gt;ctrlast AND ctri&gt;cpki AND gannline[i]&gt;gannline[i-1] AND f1f2cross AND i-f1f2crossi&lt;=crosslim)basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\t\telse if (trademode=="MA-SR")\r\n\t\t{\t\r\n\t\t\tif (cpk&lt;cpklast AND al[i]&lt;=ctr-rfac AND cpki&gt;ctri AND ganntrend==-1 AND f2f1cross AND i-f2f1crossi&lt;=crosslim)basetrend[i]=IIf(skipshort,IIf((activebuy AND al[i]&lt;=sl[i-1] AND onskipexitatsl) or (activebuy AND !onskipexitatsl),-1,0),-2);//(lastsig!=-1 OR exitsigi&gt;lastsigi)check=-2; AND \r\n\t\t\telse if (ctr&gt;ctrlast AND ah[i]&gt;=cpk+rfac  AND ctri&gt;cpki AND ganntrend==1 AND f1f2cross AND i-f1f2crossi&lt;=crosslim)basetrend[i]=sig=1;//(lastsig!=1 OR exitsigi&gt;lastsigi) AND\r\n\t\t}\r\n\r\n\r\n\t}\t\r\n\t//if (i==sbb[i])PlotText(WriteVal(sig,1.2),i,High[i]+rfac,colorWhite);\t\r\n\t\r\n\t\r\n\tif (i&gt;0 AND basetrend[i]==0)basetrend[i]=basetrend[i-1];\r\n\t\r\n\tif (i&gt;0 AND basetrend[i]!=basetrend[i-1])sig=basetrend[i];\r\n\tif (sig==1 AND lastsig==1 AND exiti&lt;lastsigi)sig=0;\r\n\tif ((sig==-2 AND lastsig==-2 AND exiti&lt;lastsigi))sig=0;\r\n\tif (sig==-2 AND skipshort)sig=0;\r\n\t\r\n\r\n\t\r\n\tif ((useautorange AND curdate&gt;autodateend) or (exitintraday AND hrmn[i]&gt;=1530))//exits trades at end of date range\r\n\t{\r\n\t\tif (lastsigi&gt;exiti)\r\n\t\t{\r\n\t\t\tif (lastsig==1)sig=-1;\r\n\t\t\tif (lastsig==-2)sig=2;\r\n\t\t}\r\n\t}\r\n\t/*if (lastsigi&gt;exiti AND tn[i]==153000)//Intraday test\r\n\t{\r\n\t\tif (lastsig==1)sig=-1;\r\n\t\tif (lastsig==-2)sig=2;\r\n\t}*/\r\n\r\n\t\r\n\t//if(i==sbb[i])PlotText(WriteVal(tn[i],1.0),i,H[i]+2*tr[i],colorWhite);\r\n\t\r\n\tif (i&gt;0)tradect[i]=tradect[i-1];\r\n\tif (sig==1){\r\n\t\tif (trademode=="SR-Swing" OR trademode=="SR-Break"){BuyPrice[i]=IIf(al[i]&gt;=cpk+rfac,al[i],cpk+rfac);tradetypex[i]=Buy[i]=1;}\r\n\t\telse if (trademode=="Retrace"){BuyPrice[i]=IIf(al[i]&gt;=nextsignal[i],al[i],nextsignal[i]);tradetypex[i]=Buy[i]=1;}\r\n\t\telse if (trademode=="MA-SR"){BuyPrice[i]=IIf(al[i]&gt;=cpk+rfac,al[i],cpk+rfac);tradetypex[i]=Buy[i]=1;}\r\n//\t\telse if (trademode=="MA-Retrace" OR trademode=="MA-Cross"){BuyPrice[i]=IIf(al[i]&gt;=nextsignal[i],al[i],nextsignal[i]);tradetypex[i]=Buy[i]=1;}\r\n\t\telse if (trademode=="MA-Retrace" OR trademode=="MA-Cross"){BuyPrice[i]=IIf(al[i]&gt;=nlong,al[i],nlong);tradetypex[i]=Buy[i]=1;}\r\n\r\n\t\tif (Buy[i]==1)\r\n\t\t{\r\n\t\t\ttradeprice[i]=BuyPrice[i];\r\n\t\t\tprevsig=lastsig;\r\n\t\t\tlastsig=sig;profit[i]=IIf(sigi&gt;exiti AND BuyPrice[sigi]!=0,ShortPrice[sigi]-BuyPrice[i],0);prevsigi=lastsigi;lastsigi=sigi=i;sig=0;\r\n\t\t\tsl[i]=tr[trcount]-slmult*rfac;slpoints[i]=BuyPrice[i]-sl[i];\r\n\t\t\ttradect[i]=tradect[i]+1;\r\n\t\t\tthreshflag=threshcross=threshcrossi=threshflagi=0;\r\n\t\t}\r\n\t\t}\r\n\telse if ((sig==-1 AND Lastsig==1) ){Sell[i]=1;exitprice[i]=SellPrice[i]=al[i];exiti=i;profit[i]=SellPrice[i]-BuyPrice[sigi];exitsig=-1;sig=0;}\r\n\telse if (sig==-2 AND !skipshort){\r\n\t\tif (trademode=="SR-Swing" OR trademode=="SR-Break"){ShortPrice[i]=IIf(ah[i]&lt;=ctr-rfac,ah[i],ctr-rfac);tradetypex[i]=-1;Short[i]=1;}\r\n\t\telse if (trademode=="Retrace"){ShortPrice[i]=nextsignal[i];tradetypex[i]=-1;Short[i]=1;}\r\n\t\telse if (trademode=="MA-SR" AND al[i]&lt;=ctr-rfac){ShortPrice[i]=IIf(ah[i]&lt;=ctr-rfac,ah[i],ctr-rfac);tradetypex[i]=-1;Short[i]=1;}\r\n//\t\telse if (trademode=="MA-Retrace" OR trademode=="MA-Cross"){ShortPrice[i]=IIf(ah[i]&lt;nextsignal[i],ah[i],nextsignal[i]);tradetypex[i]=-1;Short[i]=1;}\r\n\t\telse if (trademode=="MA-Retrace" OR trademode=="MA-Cross"){ShortPrice[i]=IIf(ah[i]&lt;nshort,ah[i],nshort);tradetypex[i]=-1;Short[i]=1;}\r\n\t\tif (Short[i]==1)\r\n\t\t{\r\n\t\t\ttradeprice[i]=ShortPrice[i];\r\n\t\t\tprevsig=lastsig;\r\n\t\t\tlastsig=sig;profit[i]=IIf(sigi&gt;exiti AND Lastsigi!=0,ShortPrice[i]-BuyPrice[sigi],0);prevsigi=lastsigi;lastsigi=sigi=i;sig=0;\r\n\t\t\tsl[i]=pk[pkcount]+slmult*rfac;slpoints[i]=sl[i]-ShortPrice[i];\r\n\t\t\ttradect[i]=tradect[i]+1;\r\n\t\t\tthreshflag=threshcross=threshcrossi=threshflagi=0;\r\n\t\t}\r\n\t\t}\r\n\telse if (sig==2 AND Lastsig==-2){Cover[i]=1;exitprice[i]=CoverPrice=ah[i];exiti=i;profit[i]=ShortPrice[sigi]-CoverPrice[i];exitsig=2;}\r\n\t\r\n\t\r\n\t\r\n\tif (targetmode)target=slpoints[sigi]*targetratio;\r\n\t\r\n\t\r\n\tsystemtarget[i]=target;\r\n\tsystemtarget2[i]=target*target2ratio;\r\n\tif (lastsig==1)targetlevel=systemtargetlevel[i]=BuyPrice[sigi]+target;\r\n\telse if (lastsig==-2)systemtargetlevel[i]=shortPrice[sigi]-target;\r\n\tif (i&gt;lastsigi AND lastsigi&gt;exiti)\r\n\t{\r\n\t\tslmaxprofit=tslfac*maxprofit[i-1];\r\n\t\tsl[i]=IIf(lastsig==1,sl[sigi]+slmaxprofit,sl[sigi]-slmaxprofit);slpoints[i]=slpoints[sigi]-slmaxprofit;\r\n\t\ttradetypex[i]=tradetypex[i-1];tradeprice[i]=tradeprice[i-1];\r\n\t\tif (lastsig==1 AND il[i]&lt;=sl[i] AND ih[i]&gt;=sl[i] AND tn[i]!=091500){exit=1;exiti=i;exitprice[i]=sellPrice[i]=sl[i];Sell[i]=1;}\r\n\t\telse if (lastsig==1 AND il[i]&lt;sl[i] AND ih[i]&lt;sl[i] AND tn[i]!=091500){exit=1;exiti=i;exitprice[i]=sellPrice[i]=ih[i];Sell[i]=1;}\r\n\t\telse if(lastsig==1) exitprice[i]=ah[i];\r\n\t\tif (lastsig==-2 AND ih[i]&gt;=sl[i] AND il[i]&lt;=sl[i] AND tn[i]!=091500){exit=1;exiti=i;exitprice[i]=CoverPrice[i]=sl[i];Cover[i]=1;}\r\n\t\telse if (lastsig==-2 AND ih[i]&gt;sl[i] AND il[i]&gt;sl[i] AND tn[i]!=091500){exit=1;exiti=i;exitprice[i]=CoverPrice[i]=il[i];Cover[i]=1;}\r\n\t\telse if(lastsig==-2)exitprice[i]=al[i];\r\n\t\t\r\n\t}\r\n\t\r\n\t\r\n\t//if (i==sbb[i])PlotText(WriteVal(exitprice[i],1.2),i,High[i]+2*rfac,colorWhite);\t\r\n\t\r\n\r\n\t//if (cpk&lt;cpklast AND cpki&gt;ctri AND ah[i]&gt;=ctr-rfac AND al[i]&lt;=ctr-rfac AND gannline[i]&lt;gannline[i-1])PlotText(WriteVal(-2,1.0),i,H[i]+2*tr[i],colorWhite);\r\n\t//if (ctr&gt;ctrlast AND ah[i]&gt;=cpk+rfac AND aL[i]&lt;=cpk+rfac AND ctri&gt;cpki AND gannline[i]&gt;gannline[i-1])PlotText(WriteVal(1,1.0),i,H[i]+2*tr[i],colorWhite);\r\n\t//if (i&gt;0 AND basetrend[i]!=basetrend[i-1])PlotText(WriteVal(basetrend[i],1.0),i,H[i]+2*tr[i],colorWhite);\r\n\t//if(i==sbb[i])PlotText(WriteVal(basetrend[i],1.0),i,H[i]+2*tr[i],colorWhite);\r\n\txxx=0;\r\n\tif (i&gt;0)\r\n\t{\r\n\t\t\r\n\t\tif (lastsigi==i)\r\n\t\t{\r\n\t\t\tif (prevsig!=0 AND prevsigi&gt;exiti)\r\n\t\t\t{\r\n\r\n\t\t\t\tif (threshtog)threshold=slpoints[prevsigi]+threshpoints;\r\n\t\t\t\tif (usethreshratio)threshold=slpoints[prevsigi]*threshratio;\r\n\t\t\t\t\r\n\t\t\t\tif (prevsig==1)exitprofitprev[i]=Max(shortprice[i],sl[i-1])-BuyPrice[prevsigi];\r\n\t\t\t\telse if(prevsig==-2)exitprofitprev[i]=ShortPrice[prevsigi]-buyprice[i];\r\n\t\t\t\tmaxprofitprev[i]=Max(maxprofit[i-1],exitprofitprev[i]);\r\n\t\t\t\tminprofitprev[i]=Min(minprofit[i-1],exitprofitprev[i]);\r\n\t\t\t\t\r\n\t\t\t\tprevtarget=target;\r\n\t\t\t\tprevtarget2=target2ratio*target;\r\n\t\t\t\tif (targetmode){prevtarget=slpoints[prevsigi]*targetratio;prevtarget2=prevtarget*target2ratio;}\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\tif (maxprofitprev[i]&gt;=prevtarget)targetprofitprev[i]=prevtarget;\r\n\t\t\t\telse targetprofitprev[i]=exitprofitprev[i];\r\n\t\t\t\tif (maxprofitprev[i]&gt;=prevtarget2)target2profitprev[i]=prevtarget2;\r\n\t\t\t\telse target2profitprev[i]=exitprofitprev[i];\r\n\t\t\t\tif (threshtog AND maxprofitprev[i]&gt;=threshold){threshflag=1;threshflagi=i;}\r\n\t\t\t\t//else threshflag=0;\r\n\t\t\t\tif (threshflag==1 AND i&gt;threshflagi AND exitprofitprev[i]&lt;=slpoints[prevsigi]){threshcross=1;threshcrossi=i;}\r\n\t\t\t\tif (threshcross==0)threshprofitprev[i]=exitprofitprev[i];\r\n\t\t\t\tif (threshcross OR (i&gt;prevsigi AND threshstatus[i-1]==1))threshprofitprev[i]=slpoints[prevsigi];\r\n\t\t\t\tthreshflag=threshcross=threshflagi=threshcrossi=0;\r\n\t\t\t\t//if (i==sbb[i])PlotText(WriteVal(threshprofitprev[i],1.2),i,iH[i]+10*rfac,colorWhite);\r\n\t\t\t}\r\n\t\t\tif (threshtog)threshold=slpoints[lastsigi]+threshpoints;\r\n\t\t\tif (usethreshratio)threshold=slpoints[lastsigi]*threshratio;\r\n\t\t\t\r\n\t\t\tif (lastsig==1){maxprofit[i]=ih[i]-Min(buyprice[i],sl[i-1]);minprofit[i]=0;\r\n\t\t\t\texitprofit[i]=ah[i]-BuyPrice[i];maxprice[i]=ih[i];minprice[i]=BuyPrice[i];}\r\n\t\t\telse if (lastsig==-2){maxprofit[i]=shortprice[i]-il[i];minprofit[i]=0;\r\n\t\t\t\texitprofit[i]=ShortPrice[i]-al[i];maxprice[i]=il[i];minprice[i]=ShortPrice[i];}\r\n\t\t\tif (maxprofit[i]&gt;=target)targetprofit[i]=target;\r\n\t\t\telse targetprofit[i]=exitprofit[i];\r\n\t\t\tif (maxprofit[i]&gt;=target*target2ratio)target2profit[i]=target*target2ratio;\r\n\t\t\telse target2profit[i]=exitprofit[i];\r\n\t\t\t\r\n\t\t\tbarprofit=IIf(lastsigi&gt;exiti,IIf(lastsig==1,al[i]-BuyPrice[lastsigi],ShortPrice[lastsigi]-ah[i]),exitprofit[i]);\r\n\t\t\tif (threshtog AND maxprofit[i]&gt;=threshold AND threshflag==0){threshflag=1;threshflagi=i;}\r\n\t\t\t//else threshflag=0;\r\n\t\t\tif (threshflag==1 AND i&gt;threshflagi AND barprofit&lt;=slpoints[lastsigi] and\r\n\t\t\t\tIIf(lastsig==1,ah[i]&gt;=BuyPrice[lastsigi]+target,al[i]&lt;=ShortPrice[lastsigi]-target)){threshcross=1;threshcrossi=i;}\r\n\t\t\tif (threshcross==0)threshprofit[i]=exitprofit[i];\r\n\t\t\t\r\n\t\t\tthreshprice=IIf(lastsig==1,BuyPrice[lastsigi]+threshold,ShortPrice[lastsigi]-threshold);\r\n\t\t\t\r\n\t\t\tsigxi=IIf(exiti&gt;prevsigi,exiti,prevsigi);\r\n\t\t\t\r\n\t\t\tcume[i]=cumexitprofit[i]=cumexitprofit[prevsigi]-exitprofit[prevsigi]+IIf(exiti&gt;prevsigi,exitprofit[exiti],exitprofitprev[i])+exitprofit[i];\r\n\t\t\tdispcumexitprofit[i]=dispcumexitprofit[prevsigi]+IIf(exiti&gt;prevsigi,exitprofit[exiti],exitprofitprev[i]);\r\n\t\t\t\r\n\t\t\tctprofit=IIf(exiti&gt;prevsigi,exitprofit[exiti],exitprofitprev[i]);\r\n\t\t\tcumlosse[i]=cumlosse[prevsigi]+IIf(ctprofit-brok&lt;0,ctprofit,0);\r\n\t\t\tcumgaine[i]=cumgaine[prevsigi]+IIf(ctprofit-brok&gt;=0,ctprofit,0);\r\n\t\t\tsuccesse[i]=successe[prevsigi]+IIf(ctprofit-brok&gt;=0 AND prevsigi&gt;0,1,0);\r\n\t\t\t\t\t\t\t\t\r\n\t\t\tcumt[i]=cumtargetprofit[i]=cumtargetprofit[prevsigi]-targetprofit[prevsigi]+IIf(exiti&gt;prevsigi,targetprofit[exiti],targetprofitprev[i])+targetprofit[i];\r\n\t\t\tdispcumtargetprofit[i]=dispcumtargetprofit[prevsigi]+IIf(exiti&gt;prevsigi,targetprofit[exiti],targetprofitprev[i]);\r\n\t\t\t\r\n\t\t\tctprofit=IIf(exiti&gt;prevsigi,targetprofit[exiti],targetprofitprev[i]);\r\n\t\t\tcumlosst[i]=cumlosst[prevsigi]+IIf(ctprofit-brok&lt;0,ctprofit,0);\r\n\t\t\tcumgaint[i]=cumgaint[prevsigi]+IIf(ctprofit-brok&gt;=0,ctprofit,0);\r\n\t\t\tsuccesst[i]=successt[prevsigi]+IIf(ctprofit-brok&gt;=0 AND prevsigi&gt;0,1,0);\r\n\t\t\t\r\n\t\t\tcumt2[i]=cumtarget2profit[i]=cumtarget2profit[prevsigi]-target2profit[prevsigi]+IIf(exiti&gt;prevsigi,target2profit[exiti],target2profitprev[i])+target2profit[i];\r\n\t\t\tdispcumtarget2profit[i]=dispcumtarget2profit[prevsigi]+IIf(exiti&gt;prevsigi,target2profit[exiti],target2profitprev[i]);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tctprofit=IIf(exiti&gt;prevsigi,target2profit[exiti],target2profitprev[i]);\r\n\t\t\tcumlosst2[i]=cumlosst2[prevsigi]+IIf(ctprofit-brok&lt;0,ctprofit,0);\r\n\t\t\tcumgaint2[i]=cumgaint2[prevsigi]+IIf(ctprofit-brok&gt;=0,ctprofit,0);\r\n\t\t\tsuccesst2[i]=successt2[prevsigi]+IIf(ctprofit-brok&gt;=0 AND prevsigi&gt;0,1,0);\r\n\t\t\t\r\n\t\t\tcumr[i]=cumthreshprofit[i]=cumthreshprofit[prevsigi]-threshprofit[prevsigi]+IIf(exiti&gt;prevsigi,threshprofit[exiti],threshprofitprev[i])+threshprofit[i];\r\n\t\t\tdispcumthreshprofit[i]=dispcumthreshprofit[prevsigi]+IIf(exiti&gt;prevsigi,threshprofit[exiti],threshprofitprev[i]);\r\n\t\t\t\r\n\t\t\tctprofit=IIf(exiti&gt;prevsigi,threshprofit[exiti],threshprofitprev[i]);\r\n\t\t\tcumlossr[i]=cumlossr[prevsigi]+IIf(ctprofit-brok&lt;0,ctprofit,0);\r\n\t\t\tcumgainr[i]=cumgainr[prevsigi]+IIf(ctprofit-brok&gt;=0,ctprofit,0);\r\n\t\t\tsuccessr[i]=successr[prevsigi]+IIf(ctprofit-brok&gt;=0 AND prevsigi&gt;0,1,0);\r\n\t\t\t\r\n\t\t}\r\n\t\telse if (i&gt;lastsigi AND (lastsigi&gt;exiti OR i==exiti))\r\n\t\t\r\n\t\t{\r\n\t\t\r\n\t\t\t\r\n\t\t\tif (threshtog)threshold=slpoints[lastsigi]+threshpoints;\r\n\t\t\tif (usethreshratio)threshold=slpoints[lastsigi]*threshratio;\t\t\r\n\t\t\tif (maxprice[i]==0 AND i&gt;lastsigi)maxprice[i]=maxprice[i-1];\r\n\t\t\tif (minprice[i]==0 AND i&gt;lastsigi)minprice[i]=minprice[i-1];\r\n\t\t\tif (lastsig==1){maxprofit[i]=Max(exitprice[i]-buyprice[lastsigi],maxprofit[i-1]);\r\n\t\t\t\tminprofit[i]=Min(exitprice[i]-BuyPrice[lastsigi],minprofit[i-1]);if (ih[i]&gt;maxprice[i])maxprice[i]=ih[i];}\r\n\t\t\telse if (lastsig==-2){maxprofit[i]=Max(shortprice[lastsigi]-exitprice[i],maxprofit[i-1]);\r\n\t\t\t\tminprofit[i]=min(ShortPrice[lastsigi]-exitprice[i],minprofit[i-1]);if (il[i]&lt;minprice[i])minprice[i]=il[i];}\r\n\t\t\r\n\t\t\texitprofit[i]=IIf(lastsig==1,exitprice[i]-BuyPrice[lastsigi],IIf(lastsig==-2,ShortPrice[lastsigi]-exitprice[i],exitprofit[i-1]));\r\n\t\t\tif (maxprofit[i]&gt;=target)targetprofit[i]=target;\r\n\t\t\telse targetprofit[i]=exitprofit[i];\r\n\t\t\tif (maxprofit[i]&gt;=target*target2ratio)target2profit[i]=target*target2ratio;\r\n\t\t\telse target2profit[i]=exitprofit[i];\r\n\t\t\t\r\n\t\t\tbarprofit=IIf(lastsigi&gt;exiti,IIf(lastsig==1,al[i]-BuyPrice[lastsigi],ShortPrice[lastsigi]-ah[i]),exitprofit[i]);\r\n\t\t\t\r\n\t\t\tif (threshtog AND maxprofit[i]&gt;=threshold AND threshflag==0){threshflag=1;threshflagi=i;}\r\n\t\t\t//else threshflag=0;\r\n\t\t\tif (threshflag AND i&gt;threshflagi AND barprofit&lt;=slpoints[lastsigi] AND \r\n\t\t\t\tIIf(lastsig==1,ah[i]&gt;=BuyPrice[lastsigi]+target,al[i]&lt;=ShortPrice[lastsigi]-target)){threshcross=1;threshcrossi=i;}\r\n\t\t\tif (threshcross==0)threshprofit[i]=exitprofit[i];\r\n\t\t\tif (threshcross==1){threshprofit[i]=slpoints[lastsigi];threshstatus[i]=1;}\r\n\t\t\t\r\n\t\t\t//if (i==sbb[i])PlotText(WriteVal(threshcross,1.2),i,iH[i]+10*rfac,colorWhite);\r\n\t\t\tcume[i]=cumexitprofit[i]=cumexitprofit[lastsigi]-exitprofit[lastsigi]+exitprofit[IIf(exiti&gt;lastsigi,exiti,i)];\r\n\t\t\tdispcumexitprofit[i]=dispcumexitprofit[lastsigi]+exitprofit[IIf(exiti&gt;lastsigi,exiti,i)];\r\n\t\t\t\r\n\t\t\tsigxi=IIf(lastsigi&gt;exiti OR i==exiti,lastsigi,IIf(exiti&gt;lastsigi,exiti,i));\r\n\t\t\t\r\n\t\t\tcumlosse[i]=cumlosse[lastsigi]+IIf(exitprofit[i]-brok&lt;0,exitprofit[i],0);\r\n\t\t\tcumgaine[i]=cumgaine[lastsigi]+IIf(exitprofit[i]-brok&gt;=0,exitprofit[i],0);\r\n\t\t\tsuccesse[i]=successe[lastsigi]+IIf(exitprofit[i]-brok&gt;=0 AND i==exiti,1,0);\r\n\t\t\t\r\n\t\t\tcumt[i]=cumtargetprofit[i]=cumtargetprofit[lastsigi]-targetprofit[lastsigi]+targetprofit[IIf(exiti&gt;lastsigi,exiti,i)];\r\n\t\t\tdispcumtargetprofit[i]=dispcumtargetprofit[lastsigi]+targetprofit[i]; \r\n\t\t\t\r\n\t\t\tcumlosst[i]=cumlosst[lastsigi]+IIf(targetprofit[i]-brok&lt;0,targetprofit[i],0);\r\n\t\t\tcumgaint[i]=cumgaint[lastsigi]+IIf(targetprofit[i]-brok&gt;=0,targetprofit[i],0);\t\t\r\n\t\t\tsuccesst[i]=successt[lastsigi]+IIf(targetprofit[i]-brok&gt;=0 AND i==exiti,1,0);\r\n\t\t\t\r\n\t\t\tcumt2[i]=cumtarget2profit[i]=cumtarget2profit[lastsigi]-target2profit[lastsigi]+target2profit[IIf(exiti&gt;lastsigi,exiti,i)];\r\n\t\t\tdispcumtarget2profit[i]=dispcumtarget2profit[lastsigi]+target2profit[i]; \r\n\r\n\t\t\tcumlosst2[i]=cumlosst2[sigxi]+IIf(target2profit[i]-brok&lt;0,target2profit[i],0);\r\n\t\t\tcumgaint2[i]=cumgaint2[sigxi]+IIf(target2profit[i]-brok&gt;=0,target2profit[i],0);\r\n\t\t\tsuccesst2[i]=successt2[lastsigi]+IIf(target2profit[i]-brok&gt;=0 AND i==exiti,1,0);\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tcumr[i]=cumthreshprofit[i]=cumthreshprofit[lastsigi]-threshprofit[lastsigi]+threshprofit[IIf(exiti&gt;lastsigi,exiti,i)];\r\n\t\t\tdispcumthreshprofit[i]=dispcumthreshprofit[lastsigi]+threshprofit[i]; \r\n\t\t\t\r\n\t\t\tcumlossr[i]=cumlossr[lastsigi]+IIf(threshprofit[i]-brok&lt;0,threshprofit[i],0);\r\n\t\t\tcumgainr[i]=cumgainr[lastsigi]+IIf(threshprofit[i]-brok&gt;=0,threshprofit[i],0);\r\n\t\t\tsuccessr[i]=successr[lastsigi]+IIf(threshprofit[i]-brok&gt;=0 AND i==exiti,1,0);\r\n\t\t\t\r\n\t\t\r\n\t\t}\r\n\t\t\r\n\t\tif (i&gt;exiti AND exiti&gt;lastsigi)\r\n\t\t{\r\n\t\t\tcume[i]=cumexitprofit[i]=cumexitprofit[exiti];\r\n\t\t\tcumt[i]=cumtargetprofit[i]=cumtargetprofit[exiti];\r\n\t\t\tcumt2[i]=cumtarget2profit[i]=cumtarget2profit[exiti];\r\n\t\t\tcumr[i]=cumthreshprofit[i]=cumthreshprofit[exiti];\r\n\t\t\texitprofit[i]=exitprofit[exiti];\r\n\t\t\ttargetprofit[i]=targetprofit[exiti];\t\t\r\n\t\t\ttarget2profit[i]=target2profit[exiti];\r\n\t\t\tthreshprofit[i]=threshprofit[exiti];\r\n\t\t\tdispcumexitprofit[i]=dispcumexitprofit[exiti];\r\n\t\t\tdispcumtargetprofit[i]=dispcumtargetprofit[exiti];\t\t\r\n\t\t\tdispcumtarget2profit[i]=dispcumtarget2profit[exiti];\r\n\t\t\tdispcumthreshprofit[i]=dispcumthreshprofit[exiti];\r\n\t\t\tcumlosse[i]=cumlosse[exiti];\r\n\t\t\tcumgaine[i]=cumgaine[exiti];\r\n\t\t\tcumlosst[i]=cumlosst[exiti];\r\n\t\t\tcumgaint[i]=cumgaint[exiti];\r\n\t\t\tcumlosst2[i]=cumlosst2[exiti];\r\n\t\t\tcumgaint2[i]=cumgaint2[exiti];\r\n\t\t\tcumlossr[i]=cumlossr[exiti];\r\n\t\t\tcumgainr[i]=cumgainr[exiti];\r\n\t\t\tsuccesse[i]=successe[exiti];\r\n\t\t\tsuccessr[i]=successr[exiti];\r\n\t\t\tsuccesst[i]=successt[exiti];\r\n\t\t\tsuccesst2[i]=successt2[exiti];\r\n\t\t}\t\t\r\n\t}\t\t\r\n\ttargetachieved[i]=IIf(maxprofit[i]&gt;systemtarget[i] AND lastsigi&gt;exiti,1,0);\r\n\ttarget2achieved[i]=IIf(maxprofit[i]&gt;systemtarget2[i] AND lastsigi&gt;exiti,1,0);\r\n\t\t\t \r\n\t\r\n\tif (lastsig==1 AND lastsigi&gt;exiti AND threshcross==0)\r\n\t{\r\n\t\tplotthreshold[i]=BuyPrice[lastsigi]+threshold;\r\n\t\tplottarget1[i]=systemtargetlevel[i];\r\n\t}\r\n\telse if (lastsig==-2 AND lastsigi&gt;exiti  AND threshcross==0)\r\n\t{\r\n\t\tplotthreshold[i]=shortPrice[lastsigi]-threshold;\r\n\t\tplottarget1[i]=systemtargetlevel[i];\r\n\t}\r\n\t\r\n\t\r\n\t\r\n\txxx=sl[i];\r\n\t//xxx=exitprofit[i];\r\n\t \r\n\t\r\n\r\n\t//if (profit[i]!=0)PlotText(WriteVal(profit[i],1.0),i,iH[i]+tr[i],colorWhite);\r\n\tif (showprice)\r\n\t{\r\n\t\tif (lastsigi==i AND ( (lastsig==1 AND (BuyPrice[i]&gt;ah[i] OR BuyPrice[i]&lt;al[i])) OR (lastsig==-2 AND (shortPrice[i]&gt;ah[i] OR shortPrice[i]&lt;al[i])) \r\n\t\t\tOR (lastsig==1 AND pki[pkcount]&gt;tri[trcount]) OR (lastsig==2 AND pki[pkcount]&lt;tri[trcount]) ))\r\n\t\t\tPlotText(WriteIf(lastsig==1,WriteVal(BuyPrice[i],1.2,0),writeIf(lastsig==-2,WriteVal(ShortPrice[i],1.2,0),""))+"\\nInvalid Signal",i,IIf(lastsig==1,il[i]-rfac,ih[i]+rfac),colororange);\r\n\t\telse\r\n\t\tif (i==lastsigi)PlotText(WriteIf(lastsig==1,WriteVal(BuyPrice[i],1.2,0),writeIf(lastsig==-2,WriteVal(ShortPrice[i],1.2,0),""))+"/"+WriteVal(slpoints[i],1,0)+\r\n\t\t\tWriteIf(exiti&lt;prevsigi,"\\n"+WriteVal(exitprofitprev[i],1,0)+"/"+WriteVal(threshprofitprev[i],1,0)+"/"+WriteVal(targetprofitprev[i],1,0)+"/"+WriteVal(target2profitprev[i],1,0)+"\\n"+WriteVal(maxprofitprev[i],1,0)+"/"+WriteVal(minprofitprev[i],1,0),""),i,IIf(lastsig==1,il[i]-rfac,ih[i]+rfac),colorWhite);\r\n\t\tif (i==exiti)PlotText(WriteVal(exitprice[i],1.2,0)+"\\n"+WriteVal(exitprofit[i],1,0)+"/"+WriteVal(threshprofit[i],1,0)+"/"+WriteVal(targetprofit[i],1,0)+"/"+WriteVal(target2profit[i],1,0)+"\\n"+WriteVal(maxprofit[i],1,0)+"/"+WriteVal(minprofit[i],1,0),i,IIf(lastsig==1,ih[i]+rfac,il[i]-rfac),colorWhite);\r\n\t}\r\n\tif (bardb[i]==1)PlotText(WriteVal(dtx[i],1),i,ih[i],colorWhite);\r\n//Buy sell end\r\n\r\n}\r\n}\r\nindx=ind;znextdb=znextdt=k=0;\r\n//Kagi graph\r\nfor (ind=indx-kagibarc;ind&lt;=pktrcount+rclin;ind++)\r\n\t{\r\n\t\t//if (i&gt;BarCount-1 OR zi&gt;BarCount-1)break;\r\n\t\tif ((ind&gt;2 AND rclose[ind]&gt;rclose[ind-1] AND rclose[ind]&gt;rclose[ind-2] AND Checklevel==0) OR \r\n\t\t\t\t(ind&gt;2 AND rclose[ind]&lt;rclose[ind-1] AND rclose[ind]&lt;rclose[ind-2] AND Checklevel==0))\tChecklevel=rclose[ind-2];\r\n\r\n\t\t\r\n\t\tif (zi&gt;=BarCount-1)break;\r\n\t\t//zcheck[zi]=checklevel;\r\n\t\tif (ind&gt;1 AND rclose[ind]&gt;rclose[ind-1] )//implies this is a peak\r\n\t\t{\r\n\r\n\t\t\tzi=zi+1;\r\n\t\t\tzclose[zi]=zhigh[zi]=rclose[ind];\r\n\t\t\tzopen[zi]=zlow[zi]=rclose[ind-1];\r\n\t\t\tzmid[zi]=(zclose[zi]+zopen[zi])/2;\r\n\t\t\tkagicolor[zi]=1;\r\n\t\t\tzdate[zi]=rdt[ind];\r\n\t\t\tzmonth[zi]=rmth[ind];\r\n\t\t\tzyr[zi]=ryr[ind];\r\n\t\t\tzpkno[zi]=ind;\r\n\t\t\tkstore[zi]=zi;\r\n\t\t\tzhr[zi]=rhr[ind];\r\n\t\t\tzmin[zi]=rMin[ind];\r\n\t\t\tzvol[zi]=rvol[ind];\r\n\t\t\tzdtarray[zi]=xdr[ind];\r\n\t\t\tzmaxh[zi]=IIf(IsNull(zmaxh[zi]),maxh[ind],Max(maxh[ind],zmaxh[zi]));\r\n\t\t\tzminl[zi]=IIf(IsNull(zminl[zi]),minl[ind],Min(minl[ind],zminl[zi]));\r\n\t\t\tkstore[zi]=zi;\r\n\t\t\tzminend[zi]=rminend[ind];\r\n\t\t\tzdayopen[zi]=rdayopen[ind];\r\n\t\t\tzdayclose[zi]=rdayclose[ind];\r\n\t\t\tzdaych1[zi]=rdaych1[ind];\r\n\t\t\tzdaycl1[zi]=rdaycl1[ind];\r\n\t\t\tzdaych2[zi]=rdaych2[ind];\r\n\t\t\tzdaycl2[zi]=rdaycl2[ind];\r\n\t\t\tzdtend[zi]=rdtend[ind];\r\n\t\t\tzfibhigh[zi]=fibhigh[ind];\r\n\t\t\tzfiblow[zi]=fiblow[ind];\r\n\t\t\tzdbtime[zi]=dbtime[ind];\r\n\t\t\tzdttime[zi]=dttime[ind];\r\n\t\t\t//zcheck[zi]=checklevel;\r\n\t\t\tif (kagicam)\r\n\t\t\t{\r\n\t\t\t\tzr1[zi]=rr1[ind];\r\n\t\t\t\tzr2[zi]=rr2[ind];\r\n\t\t\t\tzs1[zi]=rs1[ind];\r\n\t\t\t\tzs2[zi]=rs2[ind];\r\n\t\t\t}\r\n\t\t\t//zpiv[zi]=rpiv[ind];\r\n//Ying yang logic \r\n\t\t\t//zcheck[zi]=checklevel;\r\n\t\t\t//if (ind&gt;2 AND rclose[ind]&gt;rclose[ind-2] AND rclose[ind-2]&gt;rclose[ind-1])\r\n\t\t\tif (ind&gt;2 AND rclose[ind]&gt;rclose[ind-2] AND rclose[ind-2]&gt;rclose[ind-1])\r\n\t\t\t{\r\n\t\t\t\tvClose[zi]=vHigh[zi]=rclose[ind];\r\n\t\t\t\tVopen[zi]=Vlow[zi]=rclose[ind-2];\r\n\t\t\t\twClose[zi]=wHigh[zi]=rclose[ind-2];\r\n\t\t\t\twOpen[zi]=wLow[zi]=rclose[ind-1];\r\n\t\t\t\tarray=1;\r\n\t\t\t\tif (Vhigh[zi]&gt;=Checklevel)Vcolor[zi]=1;\r\n\t\t\t\telse if (Vhigh[zi]&lt;Checklevel)Vcolor[zi]=-1;\r\n\r\n\t\t\t\tif (wlow[zi]&lt;Checklevel)wcolor[zi]=-1;\r\n\t\t\t\telse if (wlow[zi]&gt;=Checklevel)wcolor[zi]=1;\r\n\t\t\t}\r\n\t\t\telse if (ind&gt;3 AND rclose[ind-1]&gt;=rclose[ind-3]) \r\n\t\t\t{\r\n\t\t\t\tvclose[zi]=vHigh[zi]=rclose[ind];\r\n\t\t\t\tvOpen[zi]=vlow[zi]=rclose[ind-1];\r\n\t\t\t\tarray=2;\r\n\t\t\t\tif (Vhigh[zi]&gt;Checklevel)Vcolor[zi]=1;\r\n\t\t\t\telse if (Vhigh[zi]&lt;=Checklevel)Vcolor[zi]=-1;\r\n\t\t\t}\r\n\t\t\telse if (ind&gt;3 AND rclose[ind-1]&lt;rclose[ind-3]) \r\n\t\t\t{\r\n\t\t\t\tvclose[zi]=vHigh[zi]=rclose[ind];\r\n\t\t\t\tvOpen[zi]=vlow[zi]=rclose[ind-1];\r\n\t\t\t\tarray=3;\r\n\t\t\t\tif (Vhigh[zi]&gt;Checklevel)Vcolor[zi]=1;\r\n\t\t\t\telse if (Vhigh[zi]&lt;=Checklevel)Vcolor[zi]=-1;\r\n\t\t\t}\r\n\t\t}\r\n\r\n\t\telse if (ind&gt;1 AND rclose[ind]&lt;rclose[ind-1] )//implies this is a trough\r\n\t\t{\r\n\t\t\tzi=zi+1;\r\n\t\t\tzclose[zi]=zlow[zi]=rclose[ind];\r\n\t\t\tzopen[zi]=zhigh[zi]=rclose[ind-1];\t\r\n\t\t\tzmid[zi]=(zclose[zi]+zopen[zi])/2;\r\n\t\t\tzdate[zi]=rdt[ind];\r\n\t\t\tzmonth[zi]=rmth[ind];\r\n\t\t\tzyr[zi]=ryr[ind];\r\n\t\t\tzpkno[zi]=ind;\r\n\t\t\tkagicolor[zi]=-1;\r\n\t\t\tkstore[zi]=zi;\r\n\t\t\tzhr[zi]=rhr[ind];\r\n\t\t\tzmin[zi]=rMin[ind];\r\n\t\t\tzvol[zi]=rvol[ind];\r\n\t\t\tzdtarray[zi]=xdr[ind];\r\n\t\t\tzmaxh[zi]=IIf(IsNull(zmaxh[zi]),maxh[ind],Max(maxh[ind],zmaxh[zi]));\r\n\t\t\tzminl[zi]=IIf(IsNull(zminl[zi]),minl[ind],Min(minl[ind],zminl[zi]));\r\n\t\t\tkstore[zi]=zi;\r\n\t\t\tzminend[zi]=rminend[ind];\r\n\t\t\tzdayopen[zi]=rdayopen[ind];\r\n\t\t\tzdaych1[zi]=rdaych1[ind];\r\n\t\t\tzdaycl1[zi]=rdaycl1[ind];\r\n\t\t\tzdaych2[zi]=rdaych2[ind];\r\n\t\t\tzdaycl2[zi]=rdaycl2[ind];\r\n\t\t\tzdayclose[zi]=rdayclose[ind];\r\n\t\t\tzdtend[zi]=rdtend[ind];\r\n\t\t\tzfibhigh[zi]=fibhigh[ind];\r\n\t\t\tzfiblow[zi]=fiblow[ind];\r\n\t\t\tzdbtime[zi]=dbtime[ind];\r\n\t\t\tzdttime[zi]=dttime[ind];\r\n\t\t\t//zcheck[zi]=checklevel;\r\n\t\t\tif (kagicam)\r\n\t\t\t{\r\n\t\t\t\tzr1[zi]=rr1[ind];\r\n\t\t\t\tzr2[zi]=rr2[ind];\r\n\t\t\t\tzs1[zi]=rs1[ind];\r\n\t\t\t\tzs2[zi]=rs2[ind];\r\n\t\t\t}\r\n\t\t\t//zpiv[zi]=rpiv[ind];\r\n\t\t\tif (ind&gt;2 AND rclose[ind]&lt;rclose[ind-2] AND rclose[ind-2]&lt;rclose[ind-1])\r\n\t\t\t{\r\n\t\t\t\tvopen[zi]=vHigh[zi]=rclose[ind-1];\r\n\t\t\t\tVclose[zi]=Vlow[zi]=rclose[ind-2];\r\n\t\t\t\twopen[zi]=wHigh[zi]=rclose[ind-2];\r\n\t\t\t\twclose[zi]=wLow[zi]=rclose[ind];\r\n\t\t\t\tarray=4;\r\n\t\t\t\tif (Vhigh[zi]&gt;Checklevel)Vcolor[zi]=1;\r\n\t\t\t\telse if (Vhigh[zi]&lt;Checklevel)Vcolor[zi]=-1;\r\n\r\n\t\t\t\tif (wlow[zi]&lt;=Checklevel)wcolor[zi]=-1;\r\n\t\t\t\telse if (wlow[zi]&gt;Checklevel)wcolor[zi]=1;\r\n\r\n\t\t\t}\r\n\t\t\telse if (rclose[ind]&gt;=rclose[ind-2])\r\n\t\t\t{\r\n\t\t\t\tvclose[zi]=vlow[zi]=rclose[ind];\r\n\t\t\t\tvOpen[zi]=vhigh[zi]=rclose[ind-1];\r\n\t\t\t\tarray=5;\r\n\t\t\t\tif (Vhigh[zi]&gt;Checklevel)Vcolor[zi]=1;\r\n\t\t\t\telse if (Vhigh[zi]&lt;Checklevel)Vcolor[zi]=-1;\r\n\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (zi&gt;0)Vcheck[zi]=array;\r\n\t\tif (lastind!=ind)\r\n\t\t{\r\n\t\tfor (k=zi+1;k&lt;=zi+zispace;k++)//adds the blank space \r\n\t\t{\r\n\t\t\tif (k&lt;=BarCount-1)\r\n\t\t\t{\r\n\t\t\t\tzclose[k]=zhigh[k]=zopen[k]=zlow[k]=rclose[ind];zdate[k]=zdate[zi];zmonth[k]=zmonth[zi];zyr[k]=zyr[zi];zpkno[k]=zpkno[zi];kstore[k]=k;zhr[k]=zhr[zi];zmin[k]=zmin[zi];\r\n\t\t\t\t\tif (array==1 OR array==3 OR array==5 OR array==2)vClose[k]=vHigh[k]=vopen[k]=vlow[k]=vClose[zi];Vcolor[k]=Vcolor[zi];\r\n\t\t\t\tif (array==4 OR array==5)wClose[k]=wHigh[k]=wOpen[k]=wLow[k]=wClose[zi];wcolor[k]=wcolor[zi];zmid[k]=Null;\r\n\t\t\t\tkagicolor[k]=kagicolor[zi];zvol[k]=zvol[zi];zdtarray[k]=zdtarray[zi];zmaxh[k]=zmaxh[zi];zminl[k]=zmin[zi];kstore[k]=k;zminend[k]=kminend[zi];\r\n\t\t\t\tif (kagicam){zr1[k]=zr1[zi];zr2[k]=zr2[zi];zs1[k]=zs1[zi];zs2[k]=zs2[zi];}\r\n\t\t\t\tzpiv[k]=zpiv[zi];zfibhigh[k]=zfibhigh[zi];zfiblow[k]=zfiblow[zi];zdbtime[k]=zdbtime[zi];zdttime[k]=zdttime[zi];\r\n\t\t\t}\r\n\t\t\telse break;\r\n\t\t}\r\n\t\t}\r\n\t\tzi=k-1;\r\n\t\tif (zi&gt;=1)\r\n\t\t{\r\n\t\t\treversalchosen=IIf(fixedr=="Fixed",fixedrev,IIf(fixedr=="Variable",(kagiperc/100*zhigh[zi]),brick*pnfrev));\r\n\t\t\tif (zhigh[zi]-zlow[zi]&gt;reversalchosen)\r\n\t\t\t{\r\n\t\t\t\tmclose[zi]=zhigh[zi]-reversalchosen;\r\n\t\t\t\tnclose[zi]=zlow[zi]+-reversalchosen;\r\n\t\t\t}\r\n\t\t}\r\n\t\tif (ind&gt;2 AND rclose[ind]&gt;rclose[ind-1] AND Checklevel&gt;rclose[ind-1] AND Checklevel&lt;rclose[ind])\tChecklevel=rclose[ind-1];\r\n\t\tif \t(ind&gt;2 AND rclose[ind]&lt;rclose[ind-1] AND Checklevel&gt;rclose[ind] AND Checklevel&lt;rclose[ind-1])\tChecklevel=rclose[ind-1];\r\n\t\tif (ind&gt;2 AND rclose[ind]&gt;rclose[ind-1] AND Checklevel&gt;rclose[ind])\tChecklevel=rclose[ind];\r\n\t\tif \t(ind&gt;2 AND rclose[ind]&lt;rclose[ind-1] AND Checklevel&lt;rclose[ind])\tChecklevel=rclose[ind]; \r\n\r\n\t\tlastind=ind;\r\n\t\tif (zi&gt;2)\r\n\t\t{\r\n\t\t\tznextdt[zi]=iif(((zopen[zi]&lt;zclose[zi] AND zhigh[zi]&lt;=zhigh[zi-1]) OR (zopen[zi]&gt;zclose[zi] AND zhigh[zi]==zhigh[zi-1]))\r\n\t\t\t\tAND znextdt[zi]==0,zhigh[zi-1]+rfac,0);\r\n\t\t\tznextdb[zi]=iif(((zopen[zi]&gt;zclose[zi] AND zlow[zi]&gt;=zlow[zi-1]) OR (zopen[zi]&lt;zclose[zi] AND zlow[zi]==zlow[zi-1]))\r\n\t\t\t\tAND znextdb[zi]==0,zlow[zi-1]-rfac,0);\r\n\t\t\t\r\n\t\t}\t\r\n\t}\r\n\t\r\n\r\n\tdelta=BarCount-zi-1+zispace-kagioffset;\r\n\tzopen=Ref(zopen,-delta);\r\n\tzhigh=Ref(zhigh,-delta);\r\n\tzlow=Ref(zlow,-delta);\r\n\tzclose=Ref(zclose,-delta);\r\n\tzmid=Ref(zmid,-delta);\r\n\r\n\tzyr=Ref(zyr,-delta);\r\n\tzmonth=Ref(zmonth,-delta);\r\n\tzdate=Ref(zdate,-delta);\r\n\tzpkno=Ref(zpkno,-delta);\r\n\tzhr=Ref(zhr,-delta);\r\n\tzmin=Ref(zmin,-delta);\r\n\tzvol=Ref(zvol,-delta);\r\n\tzdtarray=Ref(zdtarray,-delta);\r\n\tzmaxh=Ref(zmaxh,-delta);\r\n\tzminl=Ref(zminl,-delta);\r\n\tmclose=Ref(mclose,-delta);\r\n\tnclose=Ref(nclose,-delta);\r\n\tzminend=Ref(zminend,-delta);\r\n\tzdayopen=Ref(zdayopen,-delta);\r\n\tzdayclose=Ref(zdayclose,-delta);\r\n\tzdtend=Ref(zdtend,-delta);\r\n\tzdaych1=Ref(zdaych1,-delta);\r\n\tzdaycl1=Ref(zdaycl1,-delta);\r\n\tzdaych2=Ref(zdaych2,-delta);\r\n\tzdaycl2=Ref(zdaycl2,-delta);\r\n\tkagicolor=Ref(kagicolor,-delta);\r\n\tvclose=Ref(vclose,-delta);\r\n\tvopen=Ref(vopen,-delta);\r\n\tvhigh=Ref(vhigh,-delta);\r\n\tvlow=Ref(vlow,-delta);\r\n\twclose=Ref(wClose,-delta);\r\n\twopen=Ref(wopen,-delta);\r\n\twhigh=Ref(whigh,-delta);\r\n\twlow=Ref(wlow,-delta);\r\n\r\n\tzdbtime=Ref(zdbtime,-delta);\r\n\tzdttime=Ref(zdttime,-delta);\r\n\tznextdt=Ref(znextdt,-delta);\r\n\tznextdb=Ref(znextdb,-delta);\r\n\tVcolor=Ref(Vcolor,-delta);\r\n\twcolor=Ref(wcolor,-delta);\r\n\t\r\n\tkstore=Ref(kstore,-delta);\r\n\r\n\tVcheck=Ref(Vcheck,-delta);\r\n\t\r\n\tif (kagicam)\r\n\t{\r\n\t\tzr1=Ref(zr1,-delta);\r\n\t\tzr2=Ref(zr2,-delta);\r\n\t\tzs1=Ref(zs1,-delta);\r\n\t\tzs2=Ref(zs2,-delta);\r\n\t}\r\n\t\r\n\t\r\n\tzcheck=Ref(zcheck,-delta);\r\n\r\nLastl=Lasth=lastl1=lasth1=lastc=lasto=kr=0;ks=0;\r\nkagir1=kagir2=kagis1=kagis2=Null;\r\nsbb=SelectedValue(BarIndex());\r\nsbj=SelectedValue(jstore);\r\nsbk=SelectedValue(kstore);\r\nif (showkagima)\r\n{\r\n\tzma=(zhigh+zlow)/2;\r\n\t\r\n\t//zma=zclose;\r\n\tzmaf=IIf(Kagimatf=="MA",MA(zma,kagimaf),IIf(kagimatf=="EMA",EMA(zma,kagimaf),IIf(kagimatf=="WMA",WMA(zma,kagimaf),Null)));\r\n\tzmas=IIf(Kagimats=="MA",MA(zma,kagimas),IIf(kagimats=="EMA",EMA(zma,kagimas),IIf(kagimats=="WMA",WMA(zma,kagimas),Null)));\r\n}\r\n\r\n\r\n//Kagi graph end\r\n\r\n\r\n_SECTION_END();\r\n\r\nif (plotsrchart)\r\n{\r\n\t//SAR lines\r\n\r\n\tlastbaro=lastbarc=lastbarh=lastbarl=Null;\r\n\r\n\tavxf1=EMA(avin,avperiod1);\r\n\tavxf2=EMA(avin,avperiod2);\r\n\tavx=WMA(avin,avperiod3);\r\n\t//GraphZOrder=1;\r\n\tPlot(iC,"close",IIf(BarIndex()==BarCount-1,colorYellow,IIf(ohlccolor,IIf(io&lt;=ic,colorGreen,colorRed),ColorRGB(50,50,50))),styleBar); \r\n\t\r\n\tif (showthreshold)\r\n\t{\r\n\t\tPlot(plotthreshold,"",coloryellow,styleDashed);\r\n\t\tPlot(plottarget1,"",colorGreen,styleDashed);\r\n\t}\r\n\tif (Plotg)\r\n\t{\r\n\t//\tgannline=IIf(gannline&gt;0,gannline,Null);\r\n\t\tPlot(gannline,"Trendline",ganncolor,styleLine);\r\n\t}\r\n\tif (PlotSR)\r\n\t{\r\n\r\n\t\t/*Plot(avxf1,"",Coloryellow,styleLine|stylenolabel);\r\n\t\tPlot(avxf2,"",colorred,styleLine|stylenolabel);\r\n\t\tPlot(avx,"",colorGreen,styleLine|stylenolabel);*/\r\n\r\n\t\t//Plot(f1,"",Coloryellow,styleLine|stylenolabel);\r\n\t\t//Plot(f2,"",colorred,styleLine|stylenolabel);\r\n\t\t\r\n\t\tPlot(f1h,"",Coloryellow,styleLine|stylenolabel);\r\n\t\tPlot(f2H,"",colorGreen,styleLine|stylenolabel);\r\n\r\n\r\n\t\tPlot(f1L,"",ColorOrange,styleLine|stylenolabel);\r\n\t\tPlot(f2L,"",colorred,styleLine|stylenolabel);\r\n\r\n\t\t\r\n\t\tPlot(fx,"",colorGreen,styleLine|stylenolabel);\r\n\r\n\t\t//PlotOHLC (ah,ah,al,al,"ohlc",colorRed,styleBar); \r\n\t\tcavx=SelectedValue(avx);\r\n\r\n\r\n\t}\r\n\tif (plotsrbars)\r\n\t{\r\n\t\tPlotOHLC (ah,ah,ah,ah,"ohlc",colorGreen,styleBar); \r\n\t\tPlotOHLC (al,al,al,al,"ohlc",colorRed,styleBar); \r\n\t}\r\n\t//Plot(EMA((ah+al)/2,3),"",colorGreen,styleLine);\r\n\r\n\r\n\r\n\tGraph0=ic;\r\n\tshapen=Buy*shapeUpArrow+Short*shapeDownArrow;\r\n\tshapex=Sell*shapeHollowDownArrow+Cover*shapeHollowUpArrow;\r\n\tPlotShapes(shapen,IIf(Buy,colorWhite,colorOrange),Graph0,offset=IIf(Buy,iL,iH));\r\n\tPlotShapes(shapex,colorYellow,Graph0,IIf(Cover,iL,iH));\r\n\tPlot(sl,"",colorPink,styledashed);\r\n\tif (showcam!="None" OR showorb!="None")\r\n\t{\r\n\t\tPlotOHLC (mLine1,mLine1,mLine1,mLine1,"",ParamColor("Line 1 color",colorGreen),styleBar);\r\n\t\tPlotOHLC (mLine2,mLine2,mLine2,mLine2,"",ParamColor("Line 2 color",colorLime),styleBar);\r\n\t\tPlotOHLC (mLine3,mLine3,mLine3,mLine3,"",ParamColor("Line 3 color",colorOrange),styleBar);\r\n\t\tPlotOHLC (mLine4,mLine4,mLine4,mLine4,"",ParamColor("Line 4 color",colorRed),styleBar);\r\n\t\tPlotOHLC (mLine5,mLine5,mLine5,mLine5,"",ParamColor("Line 5 color",colorSkyblue),styleBar);\r\n\t\tif (showcam!="None")\r\n\t\t{\r\n\t\t\t\r\n\t\t\tPlotText(WriteVal(mline1[BarCount-1],1.2),BarCount,mline1[BarCount-1],colorGreen);\r\n\t\t\tPlotText(WriteVal(mline2[BarCount-1],1.2),BarCount,mline2[BarCount-1],colorlime);\r\n\t\t\tPlotText(WriteVal(mline3[BarCount-1],1.2),BarCount,mline3[BarCount-1],colororange);\r\n\t\t\tPlotText(WriteVal(mline4[BarCount-1],1.2),BarCount,mline4[BarCount-1],colorred);\r\n\t\t}\r\n\t}\r\n\r\n\tif (fillerbar)\r\n\t{\r\n\t\tfor (i=1;i&lt;=srn;i++)\r\n\t\t{\r\n\t\t\tPlotOHLC(VarGet("sr"+i),VarGet("sr"+i),VarGet("sr"+i),VarGet("sr"+i),"",colorOrange,styleBar,styleNoTitle|styleNoLabel);\r\n\t\t}\r\n\t}\r\n\r\n\t//indicator test start\r\n\tvolup=voldn=Null;\r\n\tif (showvol)\r\n\t{\r\n\t\taverage = Param("Band average", 8, 1 );\r\n\t\tVolperiod = Param("VolPeriod", 13, 1 );\r\n\t\tdevfactor = Param("Devfactor", 3.55, 0, 10, 0.01 );\r\n\t\tLowbandadjust = Param("Low band adj.", 0.9, 0, 5, 0.01 );\r\n\r\n\t\tTypical = ( ah+al+IIf(C&gt;O,ah,al))/3;\r\n\r\n\t\tAdjTyp = IIf( Typical &gt; Ref( Typical, -1 ),\r\n\t\t\t\t\t  Typical - Ref( al, -1 ),\r\n\t\t\t\t\t  Ref( Typical, -1 ) - al );\r\n\r\n\t\tDeviation = Sum( AdjTyp , VolPeriod )/ VolPeriod * devfactor;\r\n\r\n\t\tDevHigh = EMA( deviation, average );\r\n\t\tDevLow = EMA( deviation, average ) * Lowbandadjust;\r\n\r\n\t\tMedianaverage = EMA( Typical, average );\r\n\t\tvolup=EMA( Medianaverage, average ) + DevHigh;\r\n\t\tvoldn=EMA( Medianaverage, average ) - DevLow;\r\n\t\tPlot( volup, "Upper", colorViolet);\r\n\t\tPlot( voldn , "Lower", colorViolet );\r\n\t\tPlot( MA( Medianaverage, average ), "Median", colorBlue );\r\n\t}\r\n}\r\n\r\n//Indicator test end\r\nColor4=ColorBlend(colorBlack,4,mmLum);\r\nColor5=ColorBlend(colorBlack,5,mmLum);\r\nColor6=ColorBlend(colorBlack,6,mmLum);\r\nColor7=ColorBlend(colorBlack,7,mmLum);\r\n\r\n//donedeal=0;\r\nif (showsr AND (plotsrchart OR plotkagichart))\r\n//if (donedeal)\r\n{\r\n\tif (SelectedValue(pktrbar)-srarrayindex&gt;=0 AND showsr)//srarray index is count of pks and trs to look backward.\r\n\t{\r\n\t\tsrstarti=pktri[SelectedValue(pktrbar)];\t\r\n\t\t//PlotText("SR Start"+WriteVal(srarrayindex,1.),srstarti,il[srstarti]-3*brick,coloryellow); //Optional display\r\n\t\tmaxsr=minsr=0;\r\n\t\tfor (mm=0;mm&lt;srarrayindex;mm++)\r\n\t\t{\r\n\t\t\t//srarray[mm]=pktr[pktrcount-srarraylookback-mm];\r\n\t\t\tsrarray[mm]=pktr[SelectedValue(pktrbar)-mm];\r\n\t\t\tmaxsr=IIf(maxsr==0,srarray[mm],Max(maxsr,srarray[mm]));\r\n\t\t\tminsr=IIf(minsr==0,srarray[mm],Min(minsr,srarray[mm]));\r\n\t\t\t\r\n\t\t\t//Plottext(WriteVal(unit,1.),BarCount,ih[BarCount-1]+10*i,colorYellow);\r\n\t\t}\r\n\t\tmidsr=(maxsr+minsr)/2;\r\n\t\tif (showpktrfib)\r\n\t\t{\r\n\t\t\tPlot (maxsr,"",ColorRGB(0,175,175),styleLine|styleNoLabel);\r\n\t\t\tPlot (minsr,"",ColorRGB(0,175,175),styleLine|styleNoLabel);\r\n\t\t\tdiff=maxsr-minsr;\r\n\t\t\tPlot (minsr+0.236*diff,"",ColorRGB(0,100,100),styleLine|styleNoLabel);\r\n\t\t\tPlot (minsr+0.764*diff,"",ColorRGB(0,100,100),styleLine|styleNoLabel);\r\n\t\t\tPlot (minsr+0.382*diff,"",ColorRGB(75,0,0),styleLine|styleNoLabel);\r\n\t\t\tPlot (minsr+0.618*diff,"",ColorRGB(0,75,0),styleLine|styleNoLabel);\r\n\t\t\tPlot(midsr,"",ColorRGB(175,175,175),styleLine|styleNoTitle);\r\n\t\t}\r\n\t\telse \r\n\t\t{\r\n\t\t\tif (srmid)\r\n\t\t\t{\r\n\t\t\t\tPlot(midsr,"",ColorRGB(175,175,175),styleLine|styleNoTitle);\r\n\t\t\t\t//Plottext(WriteVal(midsr,1.),SelectedValue(BarIndex()),ih[SelectedValue(BarIndex())]+2*brick,colorYellow);\r\n\t\t\t}\r\n\t\t\tsrupcount=srdncount=0;\r\n\t\t\tfor (mm=0;mm&lt;srarrayindex;mm++)\r\n\t\t\t{\r\n\t\t\t\tunit=(250-250/(srarrayindex+1)*(mm+1))*.9;\r\n\t\t\t\tPlot(srarray[mm],"",ColorRGB(0,unit,unit),styleLine|styleNoTitle);\r\n\t\t\t\tif(srarray[mm]&gt;midsr)srupcount=srupcount+1;\r\n\t\t\t\telse if(srarray[mm]&lt;midsr)srdncount=srdncount+1;\r\n\t\t\t}\r\n\t\t\tif (srmid)Plottext(WriteVal(srupcount,1.)+"/"+WriteVal(srdncount,1.),SelectedValue(BarIndex()),ih[SelectedValue(BarIndex())]+2*brick,ColorRGB(75,75,75));\r\n\t\t}\r\n\t}\r\n}\r\n\r\nkagilinetype=kagithick=1;\r\nif (kagilinetype==1 AND plotkagichart)\r\n{\r\n\tif (kagithick)\r\n\t{\r\n\t\tV1o=V1h=V1l=V1c=w1O=w1H=w1L=w1C=Null;\r\n\t\tV1o=IIf(Vcolor==1,Vopen,Null);\r\n\t\tV1h=IIf(Vcolor==1,Vhigh,Null);\r\n\t\tV1l=IIf(Vcolor==1,Vlow,Null);\r\n\t\tV1c=IIf(Vcolor==1,Vclose,Null);\r\n\t\tw1O=IIf(wcolor==1,wOpen,Null);\r\n\t\tw1H=IIf(wcolor==1,wHigh,Null);\r\n\t\tw1L=IIf(wcolor==1,wLow,Null);\r\n\t\tw1C=IIf(wcolor==1,wClose,Null);\r\n\t\tPlotOHLC(v1O,v1h,v1L,v1C,"",IIf(vcolor==1,colorGreen,colorRed),128+4);\r\n\t\tPlotOHLC(w1O,w1H,w1L,w1C,"",IIf(vcolor==1,colorGreen,colorRed),128+4);\r\n\t}\r\n\r\n\tPlotOHLC(vOpen,vHigh,vLow,vClose,"",IIf(vcolor==1,colorGreen,colorRed),styleBar|stylenolabel);\r\n\tPlotOHLC(wOpen,wHigh,wLow,wClose,"",IIf(wcolor==1,colorGreen,colorRed),styleBar|stylenolabel);\r\n\tif (showmid)PlotOHLC(zmid,zmid,zmid,zmid,"",ColorRGB(100,100,100),styleBar);\r\n\r\n\t/*if (kagirev=="Gap" OR kagirev=="Yes")\r\n\t{\r\n\t\tPlotOHLC(mclose,mclose,mclose,mclose,"",ColorRGB(50,100,100),styleBar);\r\n\t\tPlotOHLC(nClose,nClose,nClose,nClose,"",ColorRGB(50,100,100),styleBar);\r\n\t}*/\r\n\t//istart=1;\r\n\t//if (BarCount-1-kagibarc&gt;0)i=BarCount-1-kagibarc;\r\n\tfor (i=1;i&lt;=BarCount-1;i++)\r\n\t{\r\n\t\t//PlotText(WriteVal(zdate[i],1.0,0),i,zhigh[i],colorWhite);\r\n\t\tif(zdate[i]!=zdate[i-1] AND i&gt;0)PlotText(WriteVal(zdate[i],1.0,0),i,zhigh[i],colorWhite); \r\n\t}\r\n\r\n}\r\n\r\n\r\n\r\nif(!plotkagichart OR showganntitle)Title =StrFormat("{{NAME}} - {{INTERVAL}} {{DATE}} - Custom Signals : Open ")+WriteVal(iO,1.2,0)+EncodeColor(colorGreen)+" Hi "+WriteVal(iH,1.2,0)+EncodeColor(colorOrange)+" Lo "+WriteVal(iL,1.2,0)+EncodeColor(colorYellow)+" Close "+WriteVal(iC,1.2,0)\r\n+EncodeColor(colorGreen)+" S/R "+ al+"/"+EncodeColor(colorOrange)+ah+EncodeColor(colorPink)+" S/R Gap "+ rfac +WriteIf(showvol,EncodeColor(colorwhite)+EncodeColor(colorPink),"")+" Set to "+sname+\r\nWriteIf(tradetypex!=0,"\\n"+Trademode+" Last "+WriteIf(tradetypex==1,"LONG ","SHORT ")+WriteVal(tradeprice,1.2,0)+" Stoploss/Points "+WriteVal(sl,1.2,0)+"/"+WriteVal(slpoints,1.,0)\r\n+" System Target Level "+WriteVal(systemtargetlevel,1.2,0)+"/"+WriteVal(systemtarget,1.2,0)+WriteIf(targetachieved,Encodecolor(colorLime)+" Target Achieved",EncodeColor(colorOrange)+" Target Not Achieved")+EncodeColor(colorpink)+\r\n" /T2/ "+WriteVal(systemtarget2,1.2,0)+WriteIf(target2achieved,Encodecolor(colorLime)+" Target2 Achieved",EncodeColor(colorOrange)+" Target2 Not Achieved")+EncodeColor(colorpink),"")+\r\n"\\nMaxprofit "+WriteVal(maxprofit,1.0,0)+" Min Profit "+WriteVal(minprofit,1.0,0)+" Exit Profit "+\r\nWriteVal(exitprofit,1.0,0)+" Threshold Profit "+WriteVal(threshprofit,1.0,0)+" Target1 Profit "+WriteVal(targetprofit,1.0,0)+" Target2 Profit "+WriteVal(target2profit,1.0,0)\r\n+"\\nCum profit "+WriteVal(cumexitprofit,1.0,0)+" Cum Threshold profit "+WriteVal(cumthreshprofit,1.0,0)+" Cum Target1 profit "+WriteVal(cumtargetprofit,1.0,0)\r\n+" Cum Target2 profit "+WriteVal(cumtarget2profit,1.0,0)\r\n+" in "+WriteVal(tradect,1,0)+" trades. Data Start " +WriteVal(stdate,1)+WriteIf(stmonth&lt;10,"-0","-")+WriteVal(stmonth,1)+"-"+WriteVal(styear,1,0)+\r\n\t\r\n"\\n"+writeif(showcam!="None"," Val above/below Cam "+WriteVal(v1,1.)+"/"+WriteVal(v2,1.),"")+\r\nWriteIf(nextsigc==1,EncodeColor(colorGreen),WriteIf(nextsigc==-1,\r\n\tEncodeColor(colorOrange),EncodeColor(colorWhite)))+\r\n\twriteif((upbarc==gannbars-1 AND nextsigc==1) OR (downbarc==gannbars-1 AND nextsigc==-1), \r\n\t"Reversal is at the next bar with level =  "+WriteVal(nextsignal,1.2),"")\r\n+WriteIf(nextsigc==1,EncodeColor(colorlime)+" Upbar count "+WriteVal(upbarc,1.0),"")+\r\nWriteIf(nextsigc==-1,EncodeColor(colororange)+" Downbar count "+WriteVal(downbarc,1.0),"");\r\n\r\nelse\r\nTitle=StrFormat("{{NAME}} - {{INTERVAL}} - Kagi ")+WriteVal(zdate,1)+","+StrExtract("Jan,Feb,Mar,Apr,May,Jun,Jul,Aug,Sep,Oct,Nov,Dec",SelectedValue(zmonth)-1)+" "+WriteVal(zyr,1,0)+" "+timecon(zhr*100+zmin)+" "+\r\n\tStrFormat(WriteIf(zopen&lt;zclose,EncodeColor(colorGreen)+"Close(H)",EncodeColor(colorRed)+"Close(L)")+" %0.2f "+WriteIf(zopen&lt;zclose,EncodeColor(colorRed)+"Open(L) ",EncodeColor(colorgreen)+"Open(H) ")+ "%0.2f",zclose,zopen)+EncodeColor(colorGreen)+" Max Hi "+WriteVal(zmaxh,1.2,0)+EncodeColor(colorred)+" Min Lo "+WriteVal(zminl,1.2,0)+\r\n\tWriteIf(znextdt&gt;0,EncodeColor(colorLime)+" Next DT "+WriteVal(znextdt,1.2,0),"")+WriteIf(znextdb&gt;0,EncodeColor(colororange)+" Next DB "+WriteVal(znextdb,1.2,0),"");\r\n\r\nVarname = Name()+chid+selyr+selmth+seldtx+selhr+selmn;\r\n\r\nif( setbuy )\r\n {\r\n   StaticVarSet( Varname, 1 );\r\n } \r\n \r\nif( setsell )\r\n {\r\n   StaticVarSet( Varname, -1 );\r\n } \r\n \r\nif( setshort )\r\n {\r\n   StaticVarSet( Varname, -2 );\r\n } \r\n \r\n\r\nif( setcover )\r\n {\r\n   StaticVarSet( Varname, 2 );\r\n }\r\n \r\n if (suppresson)\r\n {\r\n\tStaticVarSet(varname,5);\r\n }\r\n if (suppressoff)\r\n {\r\n\tStaticVarSet(varname,-5);\r\n }\r\n\r\n\r\nif( sethigh )\r\n {\r\n   StaticVarSet( Varname, 10 );\r\n } \r\nif( setlow )\r\n {\r\n   StaticVarSet( Varname, -10 );\r\n } \r\n\r\nif( clear )\r\n {\r\n   StaticVarRemove( Varname );\r\n } \r\n\r\n\r\nif (Clearall)\r\n{\r\n\tfor (i=1;i&lt;BarCount;i++)\r\n\t{\r\n\t\tVarname = Name()+chid+yr[i]+mth[i]+dtx[i]+hr[i]+mn[i];\r\n\t\tStaticVarRemove(Varname);\r\n\t}\r\n}\r\nif (writeall)\r\n{\r\n\tmydir="C:\\\\OHLC-NEW\\\\";\r\n\r\n\tfh=fopen(mydir+Name()+"rawbars.txt","w");\r\n\tds="";\r\n\r\n\tif (fh)\r\n\t{\r\n\tfor (i=0;i&lt;BarCount;i++)\r\n\t{\r\n\r\n\tds=Name()+","+WriteVal(int(Datey[i]/10000)+1900,1,0)+WriteIf(Datey[i]%1000&lt;1000,"0","")+WriteVal(Datey[i]%1000,1,0)+","+WriteIf(tn[i]&lt;100000,"0","")+WriteVal(tn[i],1.,0)+",";\r\n\tfputs(ds,fh);\r\n\tds=StrFormat("%.2f,%.2f,%.2f,%.2f,%.2f,%.2f\\n",O[i],H[i],L[i],C[i],ah[i],al[i]);\r\n\tfputs(ds,fh);\r\n\tif (i==BarCount-1)fclose(fh);\r\n\t}\r\n\r\n\t}\r\n}\r\n\r\nif (printall)\r\n{\r\n\t//mydir="C:\\\\OHLC-NEW\\\\";\r\n\tfh=fopen("srpar.txt","r");\r\n\tif (fh)\r\n\t{\r\n\t\tlread=fgets(fh);\r\n\t\tmydir=StrTrim(StrExtract(lread,1,'='),"");\r\n\t\tPlotText(mydir,BarCount-1,H[BarCount-1],colorYellow); \r\n\t\tfclose(fh);\r\n\t}\r\n\telse PlotText("Parameter File Not found",BarCount-10,H[BarCount-1],colorYellow);\r\n\r\n\tfh=fopen(mydir+Name()+"tradescsv.txt","w");\r\n\r\n\tif (fh)\r\n\t{\r\n\t\tds="Name,Date,Time,Type,TradePrice,SL-Points,Maxprofit,Minprofit,Exit Profit,Thresh Profit,Target Profit,Target2 Profit,CumExit Profit,CumThresh Profit,CumTarget Profit,CumTarget2 Profit\\n";\r\n\t\tfputs(ds,fh);lpass=0;exiti=lastsigi=prevsigi=0;\r\n\t\tfor (i=0;i&lt;BarCount;i++)\r\n\t\t{\r\n\t\t\tif (Cover[i]){exiti=i;exit=-2;}\r\n\t\t\tif (sell[i]){exiti=i;exit=2;}\t\r\n\r\n\t\t\tif ((Buy[i]==1 OR Short[i]==1 ) )\r\n\t\t\t{\r\n\t\t\t\r\n\t\t\t\tif (lastsigi&gt;0 AND lastsigi&gt;exiti)\r\n\t\t\t\t{\r\n\t\t\t\t\tds=WriteVal(maxprofitprev[i],1.2,0)+","+WriteVal(minprofitprev[i],1.2,0)+","+WriteVal(exitprofitprev[i],1.2,0)+","+\r\n\t\t\t\t\t\tWriteVal(threshprofitprev[i],1.2,0)+","+WriteVal(targetprofitprev[i],1.2,0)+","+WriteVal(target2profitprev[i],1.2,0)+","\r\n\t\t\t\t\t\t+WriteVal(dispcumexitprofit[i],1.2,0)+","+WriteVal(dispcumthreshprofit[i],1.2,0)+","+\r\n\t\t\t\t\t\tWriteVal(dispcumtargetprofit[i],1.2,0)+","+WriteVal(dispcumtarget2profit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t}\r\n\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\tif (Buy[i] ){prevsig=lastsig;prevsigi=lastsigi;lastsig=1;lastsigi=i;}\r\n\t\t\t\tif (short[i] ){prevsig=lastsig;prevsigi=lastsigi;lastsig=-1;lastsigi=i;}\r\n\t\t\t\t\r\n\t\t\t\tds=Name()+","+WriteVal(int(Datey[i]/10000)+1900,1,0)+WriteIf(Datey[i]%10000&lt;1000,"0","")+WriteVal(Datey[i]%10000,1,0)+","+timecon(int(tn[i]/100))+","\r\n\t\t\t\t\t+WriteIf(lastsig==1,"Buy,"+WriteVal(BuyPrice[i],1.2,0)+",",WriteIf(lastsig==-1,"Short,"+WriteVal(ShortPrice[i],1.2,0)+",",""))\r\n\t\t\t\t\t+WriteVal(slpoints[i],1.2,0)+",";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tif ((exiti!=i AND prevsigi&gt;exiti AND prevsigi&gt;lastsigi) OR (lastsigi!=i AND exiti==i AND exiti&gt;lastsigi AND lastsigi&gt;0 AND exiti&gt;0))\r\n\t\t\t{\r\n\t\t\t\tds=WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(threshprofit[i],1.2,0)+","+WriteVal(targetprofit[i],1.2,0)+","+WriteVal(target2profit[i],1.2,0)+","\r\n\t\t\t\t\t+WriteVal(dispcumexitprofit[i],1.2,0)+","+WriteVal(dispcumthreshprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(dispcumtargetprofit[i],1.2,0)+","+WriteVal(dispcumtarget2profit[i],1.2,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (i==BarCount-1)\r\n\t\t\t{\r\n\t\t\t\tif (lastsigi&gt;exiti)\r\n\t\t\t\t{\r\n\t\t\t\t\t//ds=WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+WriteVal(targetprofit[i],1.2,0)+","+WriteVal(dispcumexitprofit[i],1.2,0)+","+WriteVal(dispcumtargetprofit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tds=WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(threshprofit[i],1.2,0)+","+WriteVal(targetprofit[i],1.2,0)+","+WriteVal(target2profit[i],1.2,0)+","\r\n\t\t\t\t\t+WriteVal(dispcumexitprofit[i],1.2,0)+","+WriteVal(dispcumthreshprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(dispcumtargetprofit[i],1.2,0)+","+WriteVal(dispcumtarget2profit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t}\r\n\t\t\t\tif (tradect[i]&gt;0)\r\n\t\t\t\t{\r\n\r\n\t\t\t\t\tds="\\nTrade Count,,,,,,,,"+WriteVal(tradect[i],1);\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\r\n\t\t\t\t\tds="\\nSuccess Count and %age,,,,,,,,"+WriteVal(successe[i],1)+","+WriteVal(successr[i],1)+","+WriteVal(successt[i],1)+","+WriteVal(successt2[i],1)+","+\r\n\t\t\t\t\t\tWriteVal(successe[i]/tradect[i]*100,1)+","+WriteVal(successr[i]/tradect[i]*100,1)+","+WriteVal(successt[i]/tradect[i]*100,1)+","+WriteVal(successt2[i]/tradect[i]*100,1);\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\tds="\\nGain Value and %age,,,,,,,,"+WriteVal(cumgaine[i],1,0)+","+WriteVal(cumgainr[i],1,0)+","+WriteVal(cumgaint[i],1,0)+","+WriteVal(cumgaint2[i],1,0)+","+\r\n\t\t\t\t\t\tWriteVal(cumgaine[i]/(cumgaine[i]+abs(cumlosse[i]))*100,1)+","+WriteVal(cumgainr[i]/(cumgainr[i]+abs(cumlossr[i]))*100,1)+","+\r\n\t\t\t\t\t\tWriteVal(cumgaint[i]/(cumgaint[i]+abs(cumlosst[i]))*100,1)+","+WriteVal(cumgaint2[i]/(cumgaint2[i]+abs(cumlosst2[i]))*100,1);\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\tds="\\nLoss Value,,,,,,,,"+WriteVal(cumlosse[i],1,0)+","+WriteVal(cumlossr[i],1,0)+","+WriteVal(cumlosst[i],1,0)+","+WriteVal(cumlosst2[i],1,0);\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\tds="\\nNet Value(Profit),,,,,,,,"+WriteVal(cumgaine[i]+cumlosse[i],1,0)+","+WriteVal(cumgainr[i]+cumlossr[i],1,0)+","+WriteVal(cumgaint[i]+cumlosst[i],1,0)+","+WriteVal(cumgaint2[i]+cumlosst2[i],1,0);\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\t\r\n\t\t\t\t}\r\n\t\t\t\tds="\\n\\nSystem Date Start "+WriteVal(stdate,1)+WriteIf(stmonth&lt;10,"-0","-")+WriteVal(stmonth,1)+"-"+WriteVal(styear,1,0);\t\t\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="\\nS/R Gap = "+WriteVal(rfac,1,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Auto Trading = "+WriteIf(useautorange,"On\\n","Off\\n");\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Trade Method = "+Writeif(trademode=="Retrace","Retracement",WriteIf(trademode=="SR-Swing","SR Swing",\r\n\t\t\t\t\tWriteif(trademode=="MA-SR","Moving Average with SR break",Writeif(trademode=="MA-Retrace","Moving Average with Retracement",\r\n\t\t\t\t\tWriteif(trademode=="MA-Cross","Moving Average Crossover",trademode)))))+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Chart Time Interval in Seconds = "+WriteVal(Interval(0),1,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Date Range Used = "+Writeif(useautorange,WriteVal(autodatestart,1,0)+" to "+WriteVal(autodateend,1,0),"No")+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds=WriteIf(targetmode,"Target 1 Ratio = ","Absolute target =  ")+Writeif(targetmode,WriteVal(targetratio,1.1,0)+":1",WriteVal(target,1.2,0))+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Target 2 Ratio = "+WriteVal(target2ratio,1.1,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds=WriteIf(usethreshratio," Threshold Ratio "+Writeval(threshratio,1.1),"Threshold points "+WriteVal(threshpoints,1,0))+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Stop loss multiplier = "+WriteVal(slmult,1.1,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t\tds="Trailing Stop Ratio = "+WriteVal(tslfac,1.1,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\r\n\r\n\t\t\t\t\r\n\t\t\t\tfclose(fh);\r\n\t\t\t}\r\n\t\t\t\r\n\t\t\t//if (i==BarCount-1)fclose(fh);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nif (Writetrades)\r\n{\r\n\tfh=fopen("srpar.txt","r");\r\n\tif (fh)\r\n\t{\r\n\t\tlread=fgets(fh);\r\n\t\tmydir=StrTrim(StrExtract(lread,1,'='),"");\r\n\t\tPlotText(mydir,BarCount-1,H[BarCount-1],colorYellow); \r\n\t\tfclose(fh);\r\n\t}\r\n\telse PlotText("Parameter File Not found",BarCount-10,H[BarCount-1],colorYellow);\r\n\r\n\tfh=fopen(mydir+Name()+"tradescsv.txt","w");\r\n\r\n\tif (fh)\r\n\t{\r\n\t\tds="Name,Date,Time,Type,TradePrice,SL-Points,Maxprofit,Minprofit,ExitProfit,TargetProfit,CumExitProfit,CumTargetProfit,\\n";\r\n\t\tfputs(ds,fh);lpass=0;exiti=lastsigi=prevsigi=0;\r\n\t\tfor (i=0;i&lt;BarCount;i++)\r\n\t\t{\r\n\t\t\tif (Cover[i]){exiti=i;exit=-2;}\r\n\t\t\tif (sell[i]){exiti=i;exit=2;}\t\r\n\r\n\t\t\tif ((Buy[i]==1 OR Short[i]==1 ) )\r\n\t\t\t{\r\n\t\t\t\r\n\t\t\t\tif (lastsigi&gt;0 AND lastsigi&gt;exiti)\r\n\t\t\t\t{\r\n\t\t\t\t\tds=WriteVal(maxprofitprev[i],1.2,0)+","+WriteVal(minprofitprev[i],1.2,0)+","+WriteVal(exitprofitprev[i],1.2,0)+","+\r\n\t\t\t\t\t\tWriteVal(targetprofitprev[i],1.2,0)+","+WriteVal(dispcumexitprofit[i],1.2,0)+","+\r\n\t\t\t\t\t\tWriteVal(dispcumtargetprofit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t}\r\n\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\tif (Buy[i] ){prevsig=lastsig;prevsigi=lastsigi;lastsig=1;lastsigi=i;}\r\n\t\t\t\tif (short[i] ){prevsig=lastsig;prevsigi=lastsigi;lastsig=-1;lastsigi=i;}\r\n\t\t\t\t\r\n\t\t\t\tds=Name()+","+WriteVal(int(Datey[i]/10000)+1900,1,0)+WriteIf(Datey[i]%10000&lt;1000,"0","")+WriteVal(Datey[i]%10000,1,0)+","+timecon(int(tn[i]/100))+","\r\n\t\t\t\t\t+WriteIf(lastsig==1,"Buy,"+WriteVal(BuyPrice[i],1.2,0)+",",WriteIf(lastsig==-1,"Short,"+WriteVal(ShortPrice[i],1.2,0)+",",""))\r\n\t\t\t\t\t+WriteVal(slpoints[i],1.2,0)+",";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t}\r\n\t\t\t\t\r\n\t\t\tif ((exiti!=i AND prevsigi&gt;exiti AND prevsigi&gt;lastsigi) OR (lastsigi!=i AND exiti==i AND exiti&gt;lastsigi AND lastsigi&gt;0 AND exiti&gt;0))\r\n\t\t\t{\r\n\t\t\t\tds=WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(targetprofit[i],1.2,0)+","+WriteVal(dispcumexitprofit[i],1.2,0)+","+\r\n\t\t\t\t\tWriteVal(dispcumtargetprofit[i],1.2,0)+"\\n";\r\n\t\t\t\tfputs(ds,fh);\r\n\t\t\t}\r\n\r\n\r\n\r\n\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\t\r\n\t\t\tif (i==BarCount-1)\r\n\t\t\t{\r\n\t\t\t\tif (lastsigi&gt;exiti)\r\n\t\t\t\t{\r\n\t\t\t\t\tds=WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+WriteVal(targetprofit[i],1.2,0)+","+WriteVal(dispcumexitprofit[i],1.2,0)+","+WriteVal(dispcumtargetprofit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\t/*ds=Name()+","+WriteVal(int(Datey[i]/10000)+1900,1,0)+WriteIf(Datey[i]%100&lt;10,"0","")+WriteVal(Datey[i]%100,1,0)+","+WriteIf(tn[i]&lt;100000,"0","")+WriteVal(tn[i],1.,0)+",";\r\n\t\t\t\t\tfputs(ds,fh);\r\n\t\t\t\t\tds=WriteIf(lastsig==1,"EXIT,"+WriteVal(ah[i],1.2,0)+",",WriteIf(lastsig==-1,"EXIT,"+WriteVal(al[i],1.2,0)+",",",,"))+WriteVal(maxprofit[i],1.2,0)+","+WriteVal(minprofit[i],1.2,0)+","+WriteVal(exitprofit[i],1.2,0)+","+WriteVal(targetprofit[i],1.2,0)+","+WriteVal(cumexitprofit[i],1.2,0)+","+WriteVal(cumtargetprofit[i],1.2,0)+"\\n";\r\n\t\t\t\t\tfputs(ds,fh);*/\r\n\t\t\t\t}\r\n\r\n\t\t\t}\r\n\r\n\t\t\t//if (i==BarCount-1)fclose(fh);\r\n\t\t}\r\n\t}\r\n}\r\n\r\nif (Readtrades)\r\n{\r\n\tfh=fopen("srpar.txt","r");\r\n\tif (fh)\r\n\t{\r\n\t\tlread=fgets(fh);\r\n\t\tmydir=StrTrim(StrExtract(lread,1,'='),"");\r\n\t\tPlotText(mydir,BarCount-1,H[BarCount-1],colorYellow); \r\n\t\tfclose(fh);\r\n\t}\r\n\telse PlotText("Parameter File Not found",BarCount-10,H[BarCount-1],colorYellow);\r\n\r\n}\r\n\r\n\r\n</Formula>
			<FilePath>Formulas\\Drag-drop\\_OBV.afl</FilePath>
			<Flags>256</Flags>
			<MoreFlags>1342177281</MoreFlags>
			<Min>9.66523e+08</Min>
			<Max>1.10404e+09</Max>
		</Pane>
	</Sheet>
</Window>
